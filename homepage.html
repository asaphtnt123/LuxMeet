
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LuxMeet - Encontros com Eleg√¢ncia</title>
  
  <!-- Meta tags para SEO -->
  <meta name="description" content="LuxMeet - Encontros com Eleg√¢ncia. Descubra uma nova experi√™ncia de relacionamentos exclusivos.">
  <meta name="keywords" content="LuxMeet, relacionamentos de luxo, sugar daddy, sugar mommy, site de encontros, eleg√¢ncia">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Folhas de Estilo -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-z4kYwXO1EwPZuBz9Wkl4zXV9ccmgKvZSfm7t87vpoF+9wEh2+/iK6dFjp6mHlZ+zpJ5F5xVYteF4eKsmGcZYRw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Estilos -->
<link rel="stylesheet" href="styles.css">

</head>
<body>


<div id="modalLimitLike" class="modal-limit-like" style="display: none;">
    <div class="modal-content">
        <h2>Limite de Curtidas Di√°rias Atingido</h2>
        <p>Voc√™ atingiu o limite de curtidas di√°rias. Para ter curtidas ilimitadas, assine o plano VIP.</p>
        <div class="modal-actions">
            <button id="becomeVip" class="btn btn-warning">Assinar VIP</button>
            <button id="cancelLike" class="btn btn-secondary">Cancelar</button>
        </div>
    </div>
</div>




<div id="albumModal" class="modal" style="display: none;">
    <div class="modal-content">
        <button class="close-button" onclick="closeAlbumModal()">Fechar</button>
		
        <h2 class="modal-title"></h2> <!-- T√≠tulo do √°lbum -->
        <div class="modal-body" id="albumImagesContainer"></div> <!-- Grade de imagens -->
    </div>
</div>

<!-- Modal para exibir a imagem ampliada -->
<div id="imagePreviewModal" class="modal" style="display: none;">
    <div class="modal-content">
        <button class="close-button" onclick="closeImagePreview()">Fechar</button>
        <img id="previewImage" class="preview-image" src="" alt="Imagem ampliada" />
    </div>
</div>




<!-- Overlay para visualiza√ß√£o de imagem em tela cheia -->
<div id="imageOverlay" class="image-overlay" onclick="closeOverlay()" style="display: none;">
    <img id="overlayImage" src="" alt="Imagem Expandida" class="expanded-image">
</div>
<!-- Modal de Perfil do Usu√°rio -->
<div id="profileModal" class="profile-modal" style="display: none;">
    <div class="profile-content">
        <span class="close-btn" onclick="closeProfileModal()">√ó</span>
        <img id="profile-photo" src="default-photo.jpg" alt="Foto do Usu√°rio" class="profile-photo">
        <h2 id="profile-name">Nome do Usu√°rio</h2>
        <p id="profile-info">Informa√ß√µes B√°sicas</p>

        <h3>Sobre</h3>
        <p><strong>Idade:</strong> <span id="profile-age">-</span></p>
        <p><strong>Cidade:</strong> <span id="profile-city">-</span></p>
        <p><strong>Renda:</strong> <span id="profile-income">-</span></p>
        <p><strong>Bio:</strong> <span id="profile-bio">-</span></p>

        <!-- Aba de navega√ß√£o com bot√µes -->
        <div class="profile-tabs">
            <button onclick="showSection('gallery')" class="tab-button active">Galeria de Imagens</button>
            <button onclick="showSection('timeline', 'userIdDoCard')">Ver Time-line</button>

        </div>
<div id="errorMessage"></div>





<!-- Modal de Confirma√ß√£o -->
<div id="confirmationModal" style="display: none;">
    <div class="modal-content">
        <h3 id="album-name">√Ålbum: </h3>
        <p id="cost-info">Custo: 0 pontos</p>
        <button id="confirm-access-btn">Confirmar Acesso</button>
        <button id="cancel-access-btn">Cancelar</button>
    </div>
</div>

<!-- Modal de Parabeniza√ß√£o -->
<div id="congratulationsModal" style="display: none;">
    <div class="modal-content">
        <h3>Parab√©ns!</h3>
        <p>Voc√™ tem acesso ao √°lbum!</p>
        <button onclick="closeCongratulationsModal()">Fechar</button>
    </div>
</div>
        <!-- Se√ß√£o da Galeria -->	<!-- Container para os √°lbuns -->
<div id="profile-albums" class="profile-albums">
    <!-- Os √°lbuns carregados ser√£o exibidos aqui -->
</div>

        <!-- Se√ß√£o da Time-line -->
        <div id="profile-timeline" class="profile-section" style="display: none;">
            <p>Aqui estar√° a Time-line do usu√°rio...</p>
            <!-- Cont√™iner para as postagens da "Minha Time-line" -->
            <div id="userPosts" class="user-posts"></div>
        </div>
    </div>
</div>






<div id="matchNotificationCard" style="display: none;">
    <div class="notification-content">
        <h3>üéâ Parab√©ns!</h3>
        <p>Voc√™ deu match com <span id="matchedUserName"></span>!</p>
<button onclick="toggleMatches()">Ver Meus Matches</button>
        <button onclick="closeNotification()">Fechar</button>
    </div>

</div>







  <div id="scrollToTopButton" class="text-right mt-3">
  <button class="btn btn-secondary" onclick="scrollToTop()">
    <i class="fas fa-arrow-up"></i>
  </button>
</div>
<!-- PreLoader -->
<div id="preloader" style="display: none;">
    <div id="status">&nbsp;</div>
    <div class="loader">
        <span class="loader-bolinhas"></span>
        <span class="title">Carregando...</span>
    </div>
</div>
<!-- PreLoader -->

<!-- Container do perfil do usu√°rio -->
<div class="profile-container d-flex align-items-center p-3 bg-dark position-sticky top-0 z-index-100">

<div id="statusBar" style="text-align: center; padding: 10px; background-color: #f1f1f1; font-size: 18px; font-weight: bold;">
    <!-- O texto ser√° inserido aqui -->
</div>

  <img src="" alt="Foto de Perfil" class="profile-avatar rounded-circle mr-3 border" id="profileAvatar">
  <div class="profile-name text-light font-weight-bold" id="profileName"></div>
<div id="likeNotification" style="position: fixed; top: 20px; right: 20px; display: none; background: #ffd700; padding: 10px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000;">
</div>


</div>
<nav class="navbar centraliza-botao" id="navbar">
    <div class="nav-content">
		<a id="btnSection8" class="botao-dourado" onclick="toggleSection('section8')"><span>Par Perfeito</span></a>
		<a id="btnSection2" class="botao-dourado" onclick="toggleSection('section2')"><span>Novidades</span></a>
		<a id="btnSection3" class="botao-dourado" onclick="toggleSection('section3')"><span>Lista de Amizades</span></a>

		<a id="btnSection1" class="botao-dourado" onclick="toggleSection('section1')"><span>Pesquisa Avan√ßada</span></a>
        
        <a id="btnSection4" class="botao-dourado" onclick="toggleSection('section4')"><span>Se√ß√£o 4</span></a>
        <a id="btnSection5" class="botao-dourado" onclick="toggleSection('section5')"><span>Se√ß√£o 5</span></a>
        <a id="btnSection6" class="botao-dourado" onclick="toggleSection('section6')"><span>Se√ß√£o 6</span></a>
		<a id="btnSection7" class="botao-dourado" onclick="toggleSection('section7')"><span>Se√ß√£o 7</span></a>


    </div>
</nav>
<div id="section1" class="section">
  <h2>Pesquisa Avan√ßada de Usu√°rios</h2>

  <div class="search-container">
    <form id="advancedSearchForm" class="luxury-form">
      <div class="form-group">
        <label for="cidade">Cidade:</label>
        <input type="text" id="cidade" name="cidade">
      </div>

      <div class="form-group">
        <label for="minAge">Idade M√≠nima:</label>
        <input type="number" id="minAge" name="minAge" min="18" max="80" placeholder="18">
      </div>

      <div class="form-group">
        <label for="maxAge">Idade M√°xima:</label>
        <input type="number" id="maxAge" name="maxAge" min="18" max="80" placeholder="80">
      </div>

      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email">
      </div>

      <div class="form-group">
        <label for="gender">G√™nero:</label>
        <select id="gender" name="gender">
          <option value="">Selecione</option>
          <option value="male">Masculino</option>
          <option value="female">Feminino</option>
        </select>
      </div>

      <div class="form-group">
        <label for="income">Renda:</label>
        <select id="income" name="income">
          <option value="">Selecione</option>
          <option value="Classe A">Classe A</option>
          <option value="Classe B">Classe B</option>
          <option value="Classe C">Classe C</option>
        </select>
      </div>

      <div class="form-group">
        <label for="name">Nome:</label>
        <input type="text" id="name" name="name">
      </div>

      <div class="form-group">
        <label for="tipouser">Tipo de Usu√°rio:</label>
        <select id="tipouser" name="tipouser">
          <option value="">Selecione</option>
          <option value="sugar_daddy">Sugar Daddy</option>
          <option value="sugar_mommy">Sugar Mommy</option>
          <option value="sugar_baby">Sugar Baby</option>
        </select>
      </div>

      <button type="submit" class="luxury-btn">üîç Buscar</button>
    </form>



    <div id="searchResults" class="user-cards-container"></div>
  </div>
</div>
<div id="modalVerifySearch" class="modal-verify-search" style="display: none;">
    <div class="modal-content">
        <h2>Acesso √† Pesquisa Avan√ßada</h2>
        <p>Esta pesquisa custa <strong>5 pontos</strong>. Deseja continuar?</p>
        <div class="modal-actions">
            <button id="confirmSearch" class="btn btn-success">Confirmar Pesquisa</button>
            <button id="becomeVip" class="btn btn-warning">Assinar VIP</button>
            <button id="cancelSearch" class="btn btn-secondary">Cancelar</button>
        </div>
    </div>
</div>


 <div id="section2" class="section ">
  <!-- Timeline de Postagens -->
   <div class="container mt-5">
    <div class="timeline-container">
      <div id="postForm" class="mb-4">
        <div class="form-group">
          <label for="postImage">Publique uma Novidade:</label>
          <div class="custom-file-container" onclick="document.getElementById('postImage').click();">
            <input type="file" id="postImage" accept="image/*">
            <img src="file:///C:/Users/Success/Desktop/projetos/MD/img/addimg.png" alt="Adicionar Imagem">
          </div>
        </div>
        <div class="form-group">
          <textarea class="form-control" id="postText" placeholder="Escreva algo..."></textarea>
        </div>
		
        <button class="btn btn-primary btn-block" id="postButton" onclick="postarNoticia()">Postar</button>
      </div>

      <!-- Modal -->
      <div id="userModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Informa√ß√µes do Usu√°rio</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="modalUserContent">
              <!-- Informa√ß√µes do usu√°rio ser√£o inseridas aqui -->
            </div>
          </div>
        </div>
      </div>

      <div class="timeline-content">
        <!-- Conte√∫do que deve ficar fixo -->
      </div>

      <div id="timelinePosts" class="timeline-posts">
        <!-- Aqui ser√£o adicionadas as postagens dinamicamente -->
      </div>

   
    </div>
  </div>
</div>






<div id="section3" class="section ">
  <h2>Solicita√ß√µes Recebidas</h2>
  <div id="receivedRequestsContainer" class="requests-container"></div>
<div id="chatContainer" class="chat-container">
  <div class="chat-header">
    <h3>Chat com Amigo</h3>
    <button class="close-chat" onclick="fecharChat()">Fechar</button>
  </div>
  <div id="chatMessages" class="chat-messages">
    <!-- Mensagens do chat ser√£o adicionadas dinamicamente aqui -->
  </div>
  <div class="chat-input">
    <textarea id="messageInput" placeholder="Digite sua mensagem..." rows="3"></textarea>
    <button id="sendButton" onclick="enviarMensagem()">Enviar</button>
  </div>
</div>

  <h2>Meus Amigos</h2>
  <div id="friendsListContainer" class="friends-container">
  

  </div>
</div>



<div id="section4" class="section ">
       
</div>
<div id="section5" class="section">
    <h2>Minha Galeria de Imagens</h2>
    <progress id="progressBar" value="0" max="100" style="display: none;"></progress>
<button onclick="openModal()">Criar Novo √Ålbum</button>




    <!-- Galeria de √°lbuns -->
    <div id="albumGallery" class="album-gallery" style="display: flex; flex-wrap: wrap; gap: 10px;">
        <!-- Os √°lbuns ser√£o carregados aqui -->
    </div>

    <!-- Conte√∫do do √°lbum selecionado -->
<div id="albumContent" style="display: none; position: relative;">
    <h3 id="albumName"></h3>
    <div id="imageGallery" style="display: flex; flex-wrap: wrap; overflow-y: auto; max-height: calc(100vh - 200px);">
        <!-- Miniaturas das imagens do √°lbum -->
    </div>
</div>



</div>

<!-- Modal para exibir imagem -->
<div id="myimagemodal" class="modalAlbum" style="display: none;">
    <span onclick="closeModal()" class="close">&times;</span>
    <img class="modal-content" id="modalImage" />
</div>


<!-- Modal para criar um novo √°lbum -->
<div id="createAlbumModal" class="modalAlbum">
    <div class="modal-content">
	
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2>Criar Novo √Ålbum</h2>
        <label for="albumNameInput">Nome do √Ålbum</label>
        <input type="text" id="albumNameInput" placeholder="Digite o nome do √°lbum" required>
        
        <label for="isPrivateCheckbox">
            <input type="checkbox" id="isPrivateCheckbox" onchange="toggleCostField()"> Tornar √°lbum privado
        </label>
        
        <div id="costField" style="display: none;">
            <label for="accessCostInput">Custo de Acesso (PTS)</label>
            <input type="number" id="accessCostInput" placeholder="Digite o custo em pontos">
        </div>
        
        <button onclick="submitAlbumForm()">Criar √Ålbum</button>

        <!-- Bot√£o de Fechar -->
        <button class="close-modal-btn" onclick="closeModal()">Fechar</button>
		
    </div>
</div>
<!-- Modal de √Ålbum de Perfil -->
<div id="ModalProfileAlbum" class="modal" style="display: none;">
    <div class="modal-content">
        <span onclick="closeModalProfileAlbum()" class="close">&times;</span>
        <h2 id="albumTitle">T√≠tulo do √Ålbum</h2>
        <div id="albumPhotos" class="album-photos"></div> <!-- Onde as fotos do √°lbum ser√£o exibidas -->
    </div>
</div>




<div id="section6" class="section">
  <h2>Adicionar Informa√ß√µes ao Perfil</h2>

  <form id="additionalInfoForm">
    <label for="firstDate2">Sugest√£o para Primeiro Encontro:</label>
    <select id="firstDate2" name="firstDate2">
      <option value="restaurante">Restaurante</option>
      <option value="cinema">Cinema</option>
      <option value="passeioAoArLivre">Passeio ao ar livre</option>
      <option value="festa">Festa</option>
      <option value="balada">Balada</option>
      <option value="igreja">Igreja</option>
      <option value="roleDeBarco">Role de barco</option>
    </select>

    <label for="religion2">Religi√£o:</label>
    <select id="religion2" name="religion2">
      <option value="cristianismo">Cristianismo</option>
      <option value="islamismo">Islamismo</option>
      <option value="judaismo">Juda√≠smo</option>
      <option value="budismo">Budismo</option>
      <option value="hinduismo">Hindu√≠smo</option>
      <option value="outra">Outra</option>
    </select>

    <label for="seeking2">Em busca de:</label>
    <select id="seeking2" name="seeking2">
      <option value="encontroCasual">Encontro casual</option>
      <option value="encontroFamiliar">Encontro familiar</option>
      <option value="encontroSigiloso">Encontro sigiloso</option>
      <option value="queroMeCasar">Quero me casar</option>
    </select>

    <label for="lifestyle2">Estilo de Vida:</label>
    <select id="lifestyle2" name="lifestyle2">
      <option value="festeiro">Festeiro</option>
      <option value="caseiro">Caseiro</option>
      <option value="churrasco">Gosto de um churrasco</option>
      <option value="praia">Vivo na praia</option>
      <option value="luxo">Vida de luxo</option>
      <option value="simplicidade">Simplicidade</option>
      <option value="cultural">Cultural</option>
      <option value="viajante">Viajante</option>
      <option value="estudante">Estudante</option>
      <option value="investimentos">Investimentos e Neg√≥cios</option>
    </select>

    <label for="hobbies2">Hobbies:</label>
    <select id="hobbies2" name="hobbies2">
      <option value="musica">M√∫sica</option>
      <option value="esportes">Esportes</option>
      <option value="leitura">Leitura</option>
      <option value="culinaria">Culin√°ria</option>
      <option value="viagens">Viagens</option>
      <option value="tecnologia">Tecnologia</option>
      <option value="arte">Arte</option>
    </select>

    <label for="sports2">Esportes:</label>
    <select id="sports2" name="sports2">
      <option value="futebol">Futebol</option>
      <option value="basquete">Basquete</option>
      <option value="volei">V√¥lei</option>
      <option value="tenis">T√™nis</option>
      <option value="natacao">Nata√ß√£o</option>
      <option value="surf">Surf</option>
      <option value="corrida">Corrida</option>
    </select>

    <button type="button" onclick="saveAdditionalInfo()">Salvar Informa√ß√µes</button>
  </form>
</div>

<!-- Container das se√ß√µes -->
<div class="section-container">
  <!-- ... outras se√ß√µes aqui ... -->

  <!-- Se√ß√£o 7: Estat√≠sticas de Popula√ß√£o -->
  <div id="section7" class="section section7">
    <h2>Estat√≠sticas de Popula√ß√£o no LuxMeet</h2>
    <div id="populationStats">
      <p>Total de Usu√°rios: <span id="totalUsersCount"></span></p>
      <p>Sugar Daddies Registrados: <span id="sugarDaddiesCount"></span></p>
      <p>Sugar Mommies Registradas: <span id="sugarMommiesCount"></span></p>
      <p>Sugar Babies Registrados: <span id="sugarBabiesCount"></span></p>
    </div>

    <h2>Estat√≠sticas de Popula√ß√£o por Faixa de Renda no LuxMeet</h2>
    <div id="incomeStats">
      <p>Ricos: <span id="ricosCount"></span></p>
      <p>Super Ricos: <span id="superRicosCount"></span></p>
      <p>Bilion√°rios: <span id="bilionariosCount"></span></p>
    </div>
  </div>
</div>


<div id="section8" class="section">
    <!-- Se√ß√£o de usu√°rios que curtiram -->
   <!-- Se√ß√£o de usu√°rios que curtiram -->
<div class="top-card-container">
    <div id="liked-users-list">
        <h2>Usu√°rios que curtiram voc√™</h2>
        <!-- Usu√°rios que curtiram voc√™ aparecer√£o aqui -->
    </div>
</div>


    <!-- Bot√£o para mostrar matches -->
 
        <button id="btnMeusMatches" class="botao-dourado" onclick="toggleMatches()">Meus Matches</button>
		
		<div id="se√ßaoMatches">
    <!-- Cont√™iner para a lista de matches -->
    <div id="matches-list" class="matches-list" style="display: none;">
        <div class="matches-header">
            <h2>Meus Matches</h2>
            <button onclick="toggleMatches()" class="close-btn">Fechar</button>
        </div>
        <div id="matches-container" class="matches-container"></div> <!-- Container onde os cards de matches ser√£o exibidos -->
    </div>
</div>

     
		


		
		
    <!-- Se√ß√£o "Todo mundo" -->
    <div class="user-list">
        <h4>Todo mundo</h4>
        <div class="user-grid" id="random-users-list">
            <!-- Usu√°rios aleat√≥rios aparecer√£o aqui -->
        </div>
    </div>

</div>


<!-- Modal de Imagem Ampliada -->
<div id="imagemModal" class="image-modal" style="display: none;">
    <span class="close-button" onclick="closeImageModal()">&times;</span>
    <img id="imagemAmpliada" src="" alt="Imagem Ampliada">
    <p id="imagemAmpliadaNome">Nome da Imagem</p>
</div>

<<div id="chatbox" style="display: none;">
    <div id="chatbox-header" style="background-color: #2C3E50; padding: 10px; color: white; display: flex; justify-content: space-between; align-items: center;">
        <div id="chatbox-username">Conversa</div>
        <button id="close-chatbox" onclick="closeChatbox()" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 20px;">‚úñ</button>
    </div>

    <!-- Cont√™iner de v√≠deo -->
    <div id="chatbox-video-container" style="display: flex; gap: 10px; padding: 10px; background-color: #f4f4f4;">
        <!-- V√≠deo local -->
        <video id="localVideo" autoplay muted style="width: 100px; height: 100px; border-radius: 5px; background-color: black;"></video>
        <!-- V√≠deo remoto -->
        <video id="remoteVideo" autoplay style="width: 100px; height: 100px; border-radius: 5px; background-color: black;"></video>
    </div>

    <div id="chatbox-messages" class="chatbox-messages"></div>

    <!-- Bot√µes acima do input -->
    <div class="chatbox-icons">
        <button class="chatbox-icon" onclick="document.getElementById('image-input').click();">
            <i class="fas fa-image"></i>
        </button>
        <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelection(event)">

        <button class="chatbox-icon" onclick="sendAudio()">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="chatbox-icon" onclick="startVideoCall()">
            <i class="fas fa-video"></i>
        </button>
        <button class="chatbox-icon" onclick="sendGift()">
            <i class="fas fa-gift"></i>
        </button>
    </div>

    <div class="chatbox-input">
        <input type="text" id="chatbox-input-message" placeholder="Digite sua mensagem...">
        <button onclick="sendChatMessage()">Enviar</button>
    </div>
</div>


<div id="image-preview-container" style="display: none; padding: 10px; text-align: center;">
    <img id="image-preview" src="" alt="Pr√©-visualiza√ß√£o da imagem" style="max-width: 100%; max-height: 200px; margin-bottom: 10px;">
    <button id="send-image-button" onclick="sendImageMessage()" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
        Enviar Imagem
    </button>
</div>

<button onclick="endCall()" style="background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 5px;">
    Encerrar Chamada
</button>


<div id="notification-bell" class="notification-bell">
  <i class="fas fa-bell"></i>
</div>

<div id="conversations-list" style="display: none;">
  <h3>Conversas Recentes</h3>
  <div id="conversations"></div>
</div>





</body>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>




<!-- Scripts -->
<script>
 // Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyA-7HOp-Ycvyf3b_03ev__8aJEwAbWSQZY",
    authDomain: "connectfamilia-312dc.firebaseapp.com",
    projectId: "connectfamilia-312dc",
    storageBucket: "connectfamilia-312dc.appspot.com",
    messagingSenderId: "797817838649",
    appId: "1:797817838649:web:1aa7c54abd97661f8d81e8",
    measurementId: "G-QKN9NFXZZQ"
};

// Inicialize Firebase
firebase.initializeApp(firebaseConfig);

// Inicialize os servi√ßos
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ** Adicione a inicializa√ß√£o do Realtime Database **
const database = firebase.database(); // Realtime Database

window.onload = function() {
    fetchReceivedLikes();
};

// Defina a vari√°vel storageRef utilizando a API do Firebase Storage
const storageRef = firebase.storage().ref();

const notificationBell = document.getElementById('notification-bell');
const conversationsList = document.getElementById('conversations-list');
const conversationsContainer = document.getElementById('conversations');

// Chama a fun√ß√£o de escuta quando o estado da autentica√ß√£o muda
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    const userId = user.uid; // Pega o ID do usu√°rio autenticado
    listenForNewMessages(userId); // Chama a fun√ß√£o para escutar novas mensagens
  } else {
    console.log("Usu√°rio n√£o autenticado");
  }
});


let currentUserId; // Vari√°vel para armazenar o ID do usu√°rio autenticado

// Monitora o estado de autentica√ß√£o do usu√°rio
firebase.auth().onAuthStateChanged(user => {
    if (user) {
        currentUserId = user.uid; // Armazena o ID do usu√°rio autenticado
        console.log('Usu√°rio autenticado com ID:', currentUserId);
    } else {
        console.log('Nenhum usu√°rio autenticado');
    }
});

 // Fun√ß√£o para alternar entre os modos de busca (b√°sica e avan√ßada)
  function toggleSearchMode(mode) {
    const basicForm = document.getElementById('basicSearchForm');
    const advancedForm = document.getElementById('advancedSearchForm');

    if (mode === 'basic') {
      basicForm.style.display = 'block';
      advancedForm.style.display = 'none';
    } else if (mode === 'advanced') {
      basicForm.style.display = 'none';
      advancedForm.style.display = 'block';
    }
  }
// Fun√ß√£o para rolar para o topo da p√°gina
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Opcional: Mostrar o bot√£o apenas quando o usu√°rio rolar para baixo
window.addEventListener('scroll', function() {
  const scrollToTopButton = document.getElementById('scrollToTopButton');
  if (window.scrollY > 300) { // Mostra o bot√£o ap√≥s rolar 300px para baixo
    scrollToTopButton.style.display = 'block';
  } else {
    scrollToTopButton.style.display = 'none';
  }
});

// Fun√ß√£o para carregar e exibir estat√≠sticas de popula√ß√£o por tipo de usu√°rio e faixa de renda
async function loadPopulationStatistics() {
  try {
    const snapshot = await firebase.firestore().collection('users').get();
    const totalUsers = snapshot.size;
    let sugarDaddiesCount = 0;
    let sugarMommiesCount = 0;
    let sugarBabiesCount = 0;
    let ricosCount = 0;
    let superRicosCount = 0;
    let bilionariosCount = 0;

    snapshot.forEach(doc => {
      const data = doc.data();
      const tipouser = data.tipouser;
      const income = data.income;

      // Contagem por tipo de usu√°rio
      if (tipouser === 'sugar_daddy') {
        sugarDaddiesCount++;
      } else if (tipouser === 'sugar_mommy') {
        sugarMommiesCount++;
      } else if (tipouser === 'sugar_baby') {
        sugarBabiesCount++;
      }

      // Contagem por faixa de renda
      if (income === 'ricos') {
        ricosCount++;
      } else if (income === 'super_ricos') {
        superRicosCount++;
      } else if (income === 'bilionarios') {
        bilionariosCount++;
      }
    });

    // Atualiza o conte√∫do na interface
    document.getElementById('totalUsersCount').textContent = totalUsers;
    document.getElementById('sugarDaddiesCount').textContent = sugarDaddiesCount;
    document.getElementById('sugarMommiesCount').textContent = sugarMommiesCount;
    document.getElementById('sugarBabiesCount').textContent = sugarBabiesCount;
    document.getElementById('ricosCount').textContent = ricosCount;
    document.getElementById('superRicosCount').textContent = superRicosCount;
    document.getElementById('bilionariosCount').textContent = bilionariosCount;
  } catch (error) {
    console.error("Erro ao carregar estat√≠sticas de popula√ß√£o: ", error);
  }
}

// Chama a fun√ß√£o para carregar as estat√≠sticas quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
  loadPopulationStatistics();
});




function saveAdditionalInfo() {
  const userId = firebase.auth().currentUser.uid;
  const userRef = firebase.firestore().collection('users').doc(userId);

  userRef.get().then((userDoc) => {
    if (userDoc.exists) {
      const userData = userDoc.data();
      const formData = {
        firstDate: document.getElementById('firstDate2').value,
        religion: document.getElementById('religion2').value,
        seeking: document.getElementById('seeking2').value,
        lifestyle: document.getElementById('lifestyle2').value,
        hobbies: document.getElementById('hobbies2').value,
        sports: document.getElementById('sports2').value
      };

      console.log('Dados do formul√°rio:', formData);
      console.log('Dados do Firestore:', userData);

      // Verifica se h√° alguma mudan√ßa nos dados
      const newData = {};
      for (const key in formData) {
        if (formData[key] && formData[key] !== userData[key]) {
          newData[key] = formData[key];
        }
      }

      console.log('Dados novos para atualiza√ß√£o:', newData);

      if (Object.keys(newData).length > 0) {
        // Atualiza o documento Firestore com os novos dados
        userRef.update(newData)
          .then(() => {
            console.log('Informa√ß√µes adicionais atualizadas com sucesso!');
          })
          .catch((error) => {
            console.error('Erro ao atualizar informa√ß√µes adicionais:', error);
          });
      } else {
        console.log('Nenhuma altera√ß√£o detectada nas informa√ß√µes adicionais.');
      }
    } else {
      console.error('Documento do usu√°rio n√£o encontrado.');
    }
  }).catch((error) => {
    console.error('Erro ao obter documento do usu√°rio:', error);
  });
}


// Evento de clique no bot√£o "Salvar Informa√ß√µes"
document.addEventListener('DOMContentLoaded', () => {
    const saveInfoButton = document.getElementById('saveInfoButton');
    if (saveInfoButton) {
        saveInfoButton.addEventListener('click', saveAdditionalInfo);
    } else {
        console.error('Bot√£o de salvar informa√ß√µes n√£o encontrado.');
    }
});




// Fun√ß√£o para buscar usu√°rios pelos IDs do array MeusLikes
async function fetchUsersByIds(userIds) {
  const usersRef = firebase.firestore().collection('users');
  const users = [];

  try {
    for (const userId of userIds) {
      const userDoc = await usersRef.doc(userId).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        users.push(userData);
      } else {
        console.log(`Usu√°rio n√£o encontrado: ${userId}`); // Log se o usu√°rio n√£o foi encontrado
      }
    }

    // Log do n√∫mero de usu√°rios encontrados
    console.log('N√∫mero de usu√°rios encontrados:', users.length);
    
    // Exibe os usu√°rios curtidos
    displayLikedUsers(users);
  } catch (error) {
    console.error('Erro ao buscar usu√°rios:', error);
  }
}

// Fun√ß√£o para exibir usu√°rios que curtiram voc√™
async function displayLikedUsers() {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        alert('Voc√™ precisa estar logado para ver os usu√°rios que curtiram voc√™.');
        return;
    }

    const currentUserId = currentUser.uid;
    const likedUsersList = document.getElementById('liked-users-list');
    likedUsersList.innerHTML = ''; // Limpa a lista antes de exibir os novos usu√°rios

    try {
        // Acessa o documento do usu√°rio atual para pegar os likes
        const userDocRef = db.collection('users').doc(currentUserId);
        const userDoc = await userDocRef.get();

        if (userDoc.exists) {
            const userData = userDoc.data();
            const meusLikes = userData.MeusLikes || []; // IDs dos usu√°rios que voc√™ curtiu

            // Busca os usu√°rios que curtiram o usu√°rio atual
            const likedUsers = [];

            for (const likedUserId of meusLikes) {
                const likedUserDoc = await db.collection('users').doc(likedUserId).get();
                if (likedUserDoc.exists) {
                    const likedUserData = likedUserDoc.data();
                    likedUserData.id = likedUserDoc.id; // Adiciona o ID ao usu√°rio
                    likedUsers.push(likedUserData);
                }
            }

           likedUsers.forEach(user => {
    const userCard = document.createElement('div');
    userCard.classList.add('card-liked'); // Classe para o card
    userCard.innerHTML = `
        <img src="${user.profilePhotoURL || 'https://via.placeholder.com/80'}" alt="${user.name}" class="small-photo">
        <p>${user.name}, ${user.dateOfBirth || ''}</p>
        <button class="match-btn" data-user-id="${user.id}">‚ù§Ô∏è Match</button>
    `;
    likedUsersList.appendChild(userCard);
});


            // Adiciona evento de clique para os bot√µes de match
            document.querySelectorAll('.match-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const matchedUserId = e.target.getAttribute('data-user-id');
                    handleMatchUser(matchedUserId); // Chama a fun√ß√£o para lidar com o match
                });
            });
        } else {
            console.log('Nenhum usu√°rio encontrado que curtiram voc√™.');
        }
    } catch (error) {
        console.error('Erro ao exibir usu√°rios que curtiram voc√™:', error);
        alert('Erro ao carregar os usu√°rios, tente novamente.');
    }
}




// Fun√ß√£o para alternar a exibi√ß√£o da lista de matches e atualizar as mensagens
function toggleMatches() {
    const matchesList = document.getElementById('matches-list');
    
    // Alterna a exibi√ß√£o da lista de matches
    if (matchesList.style.display === 'none' || matchesList.style.display === '') {
        console.log('Abrindo a lista de matches...');
        matchesList.style.display = 'block'; // Mostra a lista
        fetchUserMatches(); // Chama a fun√ß√£o para buscar e exibir os matches
    } else {
        console.log('Fechando a lista de matches...');
        matchesList.style.display = 'none'; // Esconde a lista
    }
}

// Fun√ß√£o para fechar a se√ß√£o de matches
function closeMatches() {
    const matchesList = document.getElementById('matches-list');
    matchesList.style.display = 'none'; // Esconde a lista
    console.log('Lista de matches fechada.');
}



// Fun√ß√£o para exibir os matches e monitorar novas mensagens
async function fetchUserMatches() {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        console.log('Usu√°rio n√£o est√° logado.');
        return;
    }

    const currentUserId = currentUser.uid;
    const matchesList = document.getElementById('matches-list');
    matchesList.innerHTML = ''; // Limpa a lista anterior

    try {
        console.log('Buscando dados do usu√°rio...');
        const userDocRef = db.collection('users').doc(currentUserId);
        const userDoc = await userDocRef.get();

        if (userDoc.exists) {
            const userData = userDoc.data();
            const matches = userData.Matches || []; // Obt√©m a lista de matches

            console.log('Matches encontrados:', matches);
            matches.forEach(async (matchUserId) => {
                const conversaId = [currentUserId, matchUserId].sort().join('_');
                const conversaDocRef = db.collection('conversas').doc(conversaId);

                // Inicializa a √∫ltima mensagem como "Sem mensagens ainda"
                let ultimaMensagem = "Sem mensagens ainda";

                // Fun√ß√£o para atualizar o card do match
                const updateMatchCard = async () => {
                    const conversaDoc = await conversaDocRef.get();
                    if (conversaDoc.exists) {
                        const conversaData = conversaDoc.data();
                        // Aqui buscamos a √∫ltima mensagem
                        ultimaMensagem = conversaData.lastMessage || "Sem mensagens ainda"; // Mudei aqui para 'lastMessage'
                        console.log(`√öltima mensagem com ${matchUserId}:`, ultimaMensagem);
                    }

                    // Atualiza o card correspondente
                    const matchCard = document.querySelector(`.user-card[data-user-id="${matchUserId}"]`);
                    if (matchCard) {
                        const lastMessageElement = matchCard.querySelector('.last-message');
                        lastMessageElement.textContent = ultimaMensagem;
                    }
                };

                // Inicializa o card do match
                const matchUserDoc = await db.collection('users').doc(matchUserId).get();
                if (matchUserDoc.exists) {
                    const matchUserData = { 
                        id: matchUserDoc.id, 
                        ultimaMensagem,  // Inicializa a √∫ltima mensagem
                        ...matchUserDoc.data() 
                    };
                    const matchCard = createMatchCard(matchUserData);
                    matchesList.appendChild(matchCard);

                    // Adiciona um listener para mudan√ßas na conversa
                    conversaDocRef.onSnapshot((doc) => {
                        updateMatchCard();
                    });

                    // Atualiza o card imediatamente ap√≥s a cria√ß√£o
                    await updateMatchCard(); // Adiciona esta linha para exibir a √∫ltima mensagem imediatamente
                }
            });
        } else {
            console.log('Documento do usu√°rio atual n√£o encontrado.');
            matchesList.innerHTML = '<p>Voc√™ n√£o tem matches ainda.</p>';
        }
    } catch (error) {
        console.error('Erro ao buscar matches:', error);
    }
}



// Fun√ß√£o para calcular a idade a partir da data de nascimento
function calculateAge(dateOfBirth) {
    const birthDate = new Date(dateOfBirth);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDifference = today.getMonth() - birthDate.getMonth();
    if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}

// Fun√ß√£o para criar o card do match
function createMatchCard(user) {
    console.log('Dados do usu√°rio:', user); // Adicione este log para verificar os dados do usu√°rio

    const userCard = document.createElement('div');
    userCard.classList.add('user-card-match'); // Classe atualizada
    userCard.setAttribute('data-user-id', user.id);
    
    const age = user.dateOfBirth ? calculateAge(user.dateOfBirth) : 'Idade n√£o dispon√≠vel';

    userCard.innerHTML = `
        <img src="${user.profilePhotoURL || 'https://via.placeholder.com/100'}" alt="${user.name}" class="small-photo">
        <p>${user.name}, ${age}</p> <!-- Exibe a idade em vez da data de nascimento -->
        <p class="last-message">${user.ultimaMensagem || 'Sem mensagens ainda'}</p>
        <p><strong>VIP:</strong> ${user.vip ? 'Sim' : 'N√£o'}</p>
        <p><strong>Tipo de Usu√°rio:</strong> ${user.tipouser || 'N√£o dispon√≠vel'}</p>
        <p><strong>Cidade:</strong> ${user.cidade || 'N√£o dispon√≠vel'}</p>
        <p><strong>Renda:</strong> ${user.income || 'N√£o dispon√≠vel'}</p>
        <p><strong>Bio:</strong> ${user.bio || 'N√£o dispon√≠vel'}</p>
        <div class="match-buttons" style="display: none;">
            <button class="view-profile-btn" onclick="viewProfile('${user.id}')">Ver Perfil</button>
            <button class="chat-btn" onclick="startChat('${user.id}')">Conversar</button>
            <button class="remove-match-btn" onclick="removeMatch('${user.id}')">Remover Match</button>
        </div>
    `;
    
    userCard.onclick = function() {
        const buttons = userCard.querySelector('.match-buttons');
        buttons.style.display = buttons.style.display === 'none' ? 'block' : 'none';
    };

    return userCard;
}






async function handleMatchUser(likedUserId) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para curtir um usu√°rio.');
        return;
    }

    const currentUserId = currentUser.uid;
    const currentUserRef = db.collection('users').doc(currentUserId);
    const likedUserRef = db.collection('users').doc(likedUserId);

    try {
        // Obtenha os dados do usu√°rio atual e do usu√°rio curtido
        const [currentUserDoc, likedUserDoc] = await Promise.all([
            currentUserRef.get(),
            likedUserRef.get()
        ]);

        if (currentUserDoc.exists && likedUserDoc.exists) {
            const currentUserData = currentUserDoc.data();
            const likedUserData = likedUserDoc.data();

            // Verifique se o usu√°rio curtido j√° curtiu o usu√°rio atual
            if (likedUserData.MeusLikes && likedUserData.MeusLikes.includes(currentUserId)) {
                // Adiciona ambos os usu√°rios √† lista de Matches de cada um
                await Promise.all([
                    currentUserRef.update({
                        Matches: firebase.firestore.FieldValue.arrayUnion(likedUserId)
                    }),
                    likedUserRef.update({
                        Matches: firebase.firestore.FieldValue.arrayUnion(currentUserId)
                    })
                ]);

                alert('√â um match! Voc√™s curtiram um ao outro.');
            } else {
                // Caso contr√°rio, adicione o usu√°rio curtido √† lista de MeusLikes do usu√°rio atual
                await currentUserRef.update({
                    MeusLikes: firebase.firestore.FieldValue.arrayUnion(likedUserId)
                });
                alert('Curtida enviada!');
            }
        } else {
            console.log('Usu√°rio atual ou usu√°rio curtido n√£o encontrado.');
        }
    } catch (error) {
        console.error('Erro ao processar o match:', error);
        alert('Erro ao processar o match, tente novamente.');
    }
}


async function viewProfile(userId) {
    // Mostra o modal de perfil
    document.getElementById("profileModal").style.display = "flex";

    // Carrega informa√ß√µes do perfil do Firestore
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
        const userData = userDoc.data();

        // Preenche o modal com as informa√ß√µes do usu√°rio
        document.getElementById("profile-photo").src = userData.profilePhotoURL || "default-photo.jpg";
        document.getElementById("profile-name").textContent = userData.name || "Nome do Usu√°rio";
        document.getElementById("profile-info").textContent = userData.info || "Informa√ß√µes B√°sicas";
        document.getElementById("profile-age").textContent = userData.dateOfBirth ? calculateAge(userData.dateOfBirth) : "-";
        document.getElementById("profile-city").textContent = userData.cidade || "-";
        document.getElementById("profile-income").textContent = userData.income || "-";
        document.getElementById("profile-bio").textContent = userData.bio || "-";

        // Carrega a galeria de √°lbuns do usu√°rio
        await setupProfileAlbums(userId);
        
        // Carrega a linha do tempo do usu√°rio (se necess√°rio)
        await setupUserTimeline(userId);
    } else {
        console.log("Usu√°rio n√£o encontrado");
    }
}

async function setupProfileAlbums(userId) {
    const albumsContainer = document.getElementById("profile-albums");
    albumsContainer.innerHTML = ''; // Limpa os √°lbuns

    try {
        // Obt√©m os √°lbuns do usu√°rio
        const albumsSnapshot = await db.collection('users').doc(userId).collection('MeusAlbums').get();

        if (albumsSnapshot.empty) {
            const noAlbumsMessage = document.createElement("p");
            noAlbumsMessage.textContent = "Este usu√°rio n√£o tem √°lbuns.";
            albumsContainer.appendChild(noAlbumsMessage);
            return;
        }

        for (const albumDoc of albumsSnapshot.docs) {
            const albumData = albumDoc.data();
            const albumName = albumData.albumName || "√Ålbum Sem Nome";
            const accessCost = parseInt(albumData.accessCost || 0, 10); // Custo para acessar o √°lbum
            const albumId = albumDoc.id;

            // Cria o cont√™iner para o √°lbum
            const albumDiv = document.createElement("div");
            albumDiv.classList.add("album-thumbnail");

            // Adiciona o t√≠tulo do √°lbum
            const albumTitle = document.createElement("h3");
            albumTitle.textContent = albumName;
            albumDiv.appendChild(albumTitle);

            // Carrega a imagem de capa do √°lbum
            const albumCover = await getAlbumCover(userId, albumId); // Fun√ß√£o que obt√©m a capa
            const coverImg = document.createElement("img");
            coverImg.src = albumCover || "https://via.placeholder.com/150";
            coverImg.classList.add("album-cover");
            albumDiv.appendChild(coverImg);

            // Bot√£o para visualizar o √°lbum
            const viewButton = document.createElement("button");
            viewButton.textContent = "Ver √Ålbum";
            viewButton.classList.add("btn", "btn-primary");
            viewButton.onclick = () => handleAlbumAccessForOtherUser(userId, albumId, accessCost, albumName);
            albumDiv.appendChild(viewButton);

            // Mostra o custo se for maior que 0
            if (accessCost > 0) {
                const costInfo = document.createElement("p");
                costInfo.textContent = `Custo: ${accessCost} pontos`;
                albumDiv.appendChild(costInfo);
            }

            albumsContainer.appendChild(albumDiv);
        }
    } catch (error) {
        console.error("Erro ao carregar os √°lbuns:", error);
        const errorMessage = document.createElement("p");
        errorMessage.textContent = "Erro ao carregar os √°lbuns.";
        albumsContainer.appendChild(errorMessage);
    }
}
async function handleAlbumAccessForOtherUser(userId, albumId, accessCost, albumName) {
    const albumModal = document.getElementById('albumModal');
    const albumContent = albumModal.querySelector('.modal-body');
    albumContent.innerHTML = ''; // Limpa o conte√∫do do modal

    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            alert("Voc√™ precisa estar logado para acessar os √°lbuns.");
            return;
        }

        // Refer√™ncias ao Firestore
        const userRef = db.collection('users').doc(currentUser.uid);
        const albumRef = db.collection('users').doc(userId).collection('MeusAlbums').doc(albumId);

        // Verifica os pontos do usu√°rio atual
        const userDoc = await userRef.get();
        const userPoints = parseInt(userDoc.data().points || 0, 10);

        // Verifica se o usu√°rio j√° tem acesso ao √°lbum
        const albumDoc = await albumRef.get();
        const allowedUsers = albumDoc.data().allowedUsers || [];

        if (allowedUsers.includes(currentUser.uid)) {
            console.log("Acesso j√° concedido. Abrindo o √°lbum...");
            openAlbumFromOtherUser(userId, albumId, albumName); // Abre o √°lbum
            return;
        }

        // Se o usu√°rio n√£o tiver acesso, verifica os pontos
        if (userPoints >= accessCost) {
            // Transa√ß√£o para debitar pontos e conceder acesso
            await db.runTransaction(async (transaction) => {
                const userSnapshot = await transaction.get(userRef);
                const currentPoints = parseInt(userSnapshot.data().points || 0, 10);

                if (currentPoints >= accessCost) {
                    transaction.update(userRef, { points: currentPoints - accessCost }); // Debita pontos
                    transaction.update(albumRef, {
                        allowedUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) // Concede acesso
                    });
                } else {
                    throw new Error("Pontos insuficientes.");
                }
            });

            console.log("Pontos debitados e acesso concedido.");
            openAlbumFromOtherUser(userId, albumId, albumName); // Abre o √°lbum
        } else {
            alert("Voc√™ n√£o tem pontos suficientes para acessar este √°lbum.");
        }
    } catch (error) {
        console.error("Erro ao conceder acesso ao √°lbum:", error);
        alert("Erro ao verificar os pontos. Tente novamente.");
    }
}
async function openAlbumFromOtherUser(userId, albumId, albumName) {
    const albumModal = document.getElementById('albumModal');
    const albumContent = albumModal.querySelector('.modal-body');
    albumContent.innerHTML = ''; // Limpa o conte√∫do do modal

    try {
        // Busca as imagens da subcole√ß√£o 'Imagens'
        const imagesSnapshot = await db
            .collection('users')
            .doc(userId) // ID do propriet√°rio do √°lbum
            .collection('MeusAlbums')
            .doc(albumId)
            .collection('Imagens') // Subcole√ß√£o 'Imagens'
            .get();

        if (imagesSnapshot.empty) {
            const noImagesMessage = document.createElement('p');
            noImagesMessage.textContent = `Nenhuma imagem encontrada no √°lbum "${albumName}".`;
            albumContent.appendChild(noImagesMessage);
        } else {
            imagesSnapshot.forEach((doc) => {
                const imageData = doc.data();

                if (!imageData.imageUrl) {
                    console.error(`Imagem sem URL no documento: ${doc.id}`);
                    return;
                }

                const imgElement = document.createElement('img');
                imgElement.src = imageData.imageUrl; // URL da imagem
                imgElement.alt = imageData.imageName || "Imagem sem nome"; // Nome da imagem
                imgElement.classList.add('album-image'); // Adiciona classe para estiliza√ß√£o
                albumContent.appendChild(imgElement);
            });
        }

        albumModal.querySelector('.modal-title').textContent = albumName || "√Ålbum Sem Nome";
        albumModal.style.display = 'block'; // Exibe o modal
    } catch (error) {
        console.error("Erro ao carregar as imagens do √°lbum:", error);
        const errorMessage = document.createElement('p');
        errorMessage.textContent = "Erro ao carregar as imagens. Por favor, tente novamente.";
        albumContent.appendChild(errorMessage);
    }
}




async function handleAlbumAccess(userId, albumId, accessCost, albumName) {
    const albumModal = document.getElementById('albumModal');
    const albumContent = albumModal.querySelector('.modal-body');
    albumContent.innerHTML = ''; // Limpa o conte√∫do do modal

    try {
        // Verifica se o usu√°rio est√° autenticado
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            alert("Voc√™ precisa estar logado para acessar os √°lbuns.");
            return;
        }

        // Acessa o documento do usu√°rio para verificar pontos
        const userRef = db.collection('users').doc(currentUser.uid);
        const userDoc = await userRef.get();

        if (!userDoc.exists) {
            throw new Error("Usu√°rio n√£o encontrado.");
        }

        const userPoints = parseInt(userDoc.data().points || 0, 10);
        console.log(`Usu√°rio tem ${userPoints} pontos.`);

        // Verifica se o usu√°rio j√° tem acesso ao √°lbum
        const albumRef = db.collection('users').doc(userId).collection('MeusAlbums').doc(albumId);
        const albumDoc = await albumRef.get();
        const albumData = albumDoc.data();
        const allowedUsers = albumData.allowedUsers || [];

        // Se o usu√°rio j√° tiver acesso, n√£o precisa debitar pontos
        if (allowedUsers.includes(currentUser.uid)) {
            console.log("Acesso ilimitado j√° concedido. Abrindo o √°lbum...");
            openAlbum(albumId, albumName); // Abre o √°lbum sem debitar pontos
            return;
        }

        // Verifica se o usu√°rio tem pontos suficientes
        if (userPoints >= accessCost) {
            // Se o usu√°rio tiver pontos suficientes, debita os pontos
            await db.runTransaction(async (transaction) => {
                const userSnapshot = await transaction.get(userRef);
                let currentPoints = parseInt(userSnapshot.data().points || 0, 10);

                if (currentPoints >= accessCost) {
                    const updatedPoints = currentPoints - accessCost;
                    transaction.update(userRef, { points: updatedPoints });

                    // Registra o acesso ao √°lbum para o usu√°rio
                    transaction.update(albumRef, {
                        allowedUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) // Concede o acesso
                    });

                    console.log("Pontos debitados e acesso concedido.");
                } else {
                    throw new Error("Pontos insuficientes.");
                }
            });

            // Ap√≥s conceder o acesso, abre o √°lbum
            openAlbum(albumId, albumName);
        } else {
            alert("Voc√™ n√£o tem pontos suficientes para acessar este √°lbum.");
        }
    } catch (error) {
        console.error("Erro ao debitar pontos ou conceder acesso:", error);
        alert("Erro ao verificar os pontos. Tente novamente.");
    }
}

// Fun√ß√£o para carregar as imagens do √°lbum
async function loadAlbumImages(userId, albumId, albumName) {
    const albumModal = document.getElementById('albumModal');
    const albumContent = albumModal.querySelector('.modal-body');
    albumContent.innerHTML = ''; // Limpa o conte√∫do do modal

    try {
        // Busca as imagens da subcole√ß√£o 'Imagens'
        const imagesSnapshot = await db
            .collection('users')
            .doc(userId) // ID do dono do √°lbum
            .collection('MeusAlbums')
            .doc(albumId) // ID do √°lbum
            .collection('Imagens') // Subcole√ß√£o das imagens
            .get();

        if (imagesSnapshot.empty) {
            const noImagesMessage = document.createElement('p');
            noImagesMessage.textContent = `Nenhuma imagem encontrada no √°lbum "${albumName}".`;
            albumContent.appendChild(noImagesMessage);
        } else {
            imagesSnapshot.forEach((doc) => {
                const imageData = doc.data();

                if (!imageData.imageUrl) {
                    console.error(`Imagem sem URL no documento: ${doc.id}`);
                    return;
                }

                // Cria o elemento da imagem
                const imgElement = document.createElement('img');
                imgElement.src = imageData.imageUrl;
                imgElement.alt = imageData.imageName || "Imagem sem nome";
                imgElement.classList.add('album-image'); // Classe para estiliza√ß√£o
                albumContent.appendChild(imgElement);
            });
        }

        // Exibe o modal e define o t√≠tulo do √°lbum
        albumModal.querySelector('.modal-title').textContent = albumName || "√Ålbum Sem Nome";
        albumModal.style.display = 'block';
    } catch (error) {
        console.error("Erro ao carregar as imagens do √°lbum:", error);
        const errorMessage = document.createElement('p');
        errorMessage.textContent = "Erro ao carregar as imagens. Por favor, tente novamente.";
        albumContent.appendChild(errorMessage);
    }
}



async function setupUserTimeline(userId) {
    const timelineContainer = document.getElementById("userPosts");
    timelineContainer.innerHTML = ''; // Limpa a linha do tempo

    // Obt√©m as postagens do usu√°rio na subcole√ß√£o "MinhaTimeline"
    const postsSnapshot = await db.collection('users').doc(userId).collection('MinhaTimeline').get();
    
    // Itera sobre as postagens e cria elementos para cada uma
    postsSnapshot.forEach(doc => {
        const postData = doc.data();
        const postElement = document.createElement("div");
        postElement.classList.add("post"); // Adiciona uma classe para estilo, se necess√°rio

        // Convers√£o do timestamp para uma data v√°lida
        const postDate = new Date(postData.timestamp);
        const formattedDate = postDate.toLocaleString(); // Formata a data conforme necess√°rio

        // Cria√ß√£o do conte√∫do da postagem
        postElement.innerHTML = `
            <h4>${postData.autorNome || "Autor Desconhecido"}</h4>
            <p>${postData.texto || "Conte√∫do da Postagem"}</p>
            <p><small>${isNaN(postDate.getTime()) ? "Data inv√°lida" : formattedDate}</small></p>
            ${postData.postImageUrl ? `<img src="${postData.postImageUrl}" alt="Imagem da Postagem" class="post-image">` : ''}
            <div class="post-actions">
                <button class="like-button" id="likeButton_${doc.id}">Curtir</button>
                <span id="likeCount_${doc.id}">${postData.Curtidas || 0}</span>
                <button class="dislike-button" id="dislikeButton_${doc.id}">Descurtir</button>
                <span id="dislikeCount_${doc.id}">${postData.NaoGostei || 0}</span>
                <button class="comment-button" id="commentButton_${doc.id}">Comentar</button>
            </div>
            <div class="comments-section" id="commentsSection_${doc.id}">
                <!-- Coment√°rios ser√£o carregados aqui -->
            </div>
        `;
        
        // Adiciona a postagem ao cont√™iner da timeline
        timelineContainer.appendChild(postElement);

        // Fun√ß√µes de intera√ß√£o: Curtir, Descurtir, Comentar
        setupPostInteractions(doc.id, postData);
    });
}

// Configura as intera√ß√µes de Curtir, Descurtir e Comentar
function setupPostInteractions(postId, postData) {
    const likeButton = document.getElementById(`likeButton_${postId}`);
    const dislikeButton = document.getElementById(`dislikeButton_${postId}`);
    const commentButton = document.getElementById(`commentButton_${postId}`);
    const commentsSection = document.getElementById(`commentsSection_${postId}`);

    // Curtir
    likeButton.addEventListener("click", async () => {
        const postRef = db.collection('users').doc(postData.userId).collection('MinhaTimeline').doc(postId);
        try {
            await db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);
                if (!postDoc.exists) {
                    throw new Error("Documento n√£o existe!");
                }

                // Incrementa o campo Curtidas
                const newLikes = (postDoc.data().Curtidas || 0) + 1;
                transaction.update(postRef, { Curtidas: newLikes });

                // Atualiza a classe do bot√£o de "Gostei"
                const likeButton = document.getElementById(`likeButton_${postId}`);
                if (likeButton) {
                    likeButton.classList.add('liked'); // Adiciona classe para indicar que foi curtido
                }

            });

            // Atualiza a interface do usu√°rio
            const likeCountElement = document.getElementById(`likeCount_${postId}`);
            if (likeCountElement) {
                likeCountElement.textContent = (postData.Curtidas || 0) + 1;
            } else {
                console.error('Elemento de contagem de curtidas n√£o encontrado.');
            }

        } catch (error) {
            console.error("Erro ao incrementar curtidas: ", error);
        }
    });

    // Descurtir
    dislikeButton.addEventListener("click", async () => {
        const postRef = db.collection('users').doc(postData.userId).collection('MinhaTimeline').doc(postId);
        try {
            await db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);
                if (!postDoc.exists) {
                    throw new Error("Documento n√£o existe!");
                }

                // Incrementa o campo N√£o Gostei
                const newDislikes = (postDoc.data().NaoGostei || 0) + 1;
                transaction.update(postRef, { NaoGostei: newDislikes });

                // Atualiza a classe do bot√£o de "Descurtir"
                const dislikeButton = document.getElementById(`dislikeButton_${postId}`);
                if (dislikeButton) {
                    dislikeButton.classList.add('disliked'); // Adiciona classe para indicar que foi descurtido
                }
            });

            // Atualiza a interface do usu√°rio
            const dislikeCountElement = document.getElementById(`dislikeCount_${postId}`);
            if (dislikeCountElement) {
                dislikeCountElement.textContent = (postData.NaoGostei || 0) + 1;
            } else {
                console.error('Elemento de contagem de descurtidas n√£o encontrado.');
            }

        } catch (error) {
            console.error("Erro ao incrementar descurtidas: ", error);
        }
    });

    // Comentar
    commentButton.addEventListener("click", () => {
        const commentText = prompt("Escreva seu coment√°rio:");
        if (commentText) {
            addComment(postId, commentText);
        }
    });

    // Carregar coment√°rios da postagem
    loadComments(postId, commentsSection);
}

// Fun√ß√£o para adicionar um coment√°rio
async function addComment(postId, commentText) {
    const user = firebase.auth().currentUser;
    if (!user) {
        alert("Voc√™ precisa estar logado para comentar.");
        return;
    }

    const commentData = {
        username: user.displayName || user.email,
        text: commentText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    const postRef = db.collection('users').doc(user.uid).collection('MinhaTimeline').doc(postId);
    await postRef.collection('comments').add(commentData);

    // Recarregar os coment√°rios
    const commentsSection = document.getElementById(`commentsSection_${postId}`);
    loadComments(postId, commentsSection);
}

// Fun√ß√£o para carregar coment√°rios de uma postagem
async function loadComments(postId, commentsSection) {
    const commentsSnapshot = await db.collection('users')
        .doc(firebase.auth().currentUser.uid)
        .collection('MinhaTimeline')
        .doc(postId)
        .collection('comments')
        .get();

    commentsSection.innerHTML = ''; // Limpa os coment√°rios existentes

    commentsSnapshot.forEach(commentDoc => {
        const commentData = commentDoc.data();
        const commentDiv = document.createElement('div');
        commentDiv.classList.add('comment');
        commentDiv.innerHTML = `<strong>${commentData.username}:</strong> ${commentData.text}`;
        commentsSection.appendChild(commentDiv);
    });
}


function showSection(section) {
    // Remove a classe 'active' de todos os bot√µes e esconde todas as se√ß√µes
    const buttons = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.profile-section');

    buttons.forEach(button => {
        button.classList.remove('active');
    });

    sections.forEach(sec => {
        sec.style.display = "none"; // Esconde todas as se√ß√µes
    });

    // Adiciona a classe 'active' ao bot√£o selecionado
    const activeButton = document.querySelector(`.tab-button[onclick="showSection('${section}')"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }

    // Exibe a se√ß√£o selecionada
    const activeSection = document.getElementById(`profile-${section}`);
    if (activeSection) {
        activeSection.style.display = "block"; // Exibe a se√ß√£o selecionada
    }
}
// Fun√ß√£o para carregar e exibir postagens da timelineLux
const loadUserTimeline = async (userId) => {
    const userPostsDiv = document.getElementById('userPosts'); // Obter o cont√™iner para postagens
    if (userPostsDiv) {
        userPostsDiv.innerHTML = ''; // Limpa o conte√∫do atual

        if (userId) {
            const postsSnapshot = await db.collection('timelineLux')
                .where('autorId', '==', userId) // Filtra as postagens pelo userId recebido
                .orderBy('timestamp', 'desc')
                .get();
            
            for (const doc of postsSnapshot.docs) {
                const postData = doc.data();
                const postElement = await criarElementoPost({ ...postData, id: doc.id });
                userPostsDiv.appendChild(postElement); // Adiciona o elemento ao cont√™iner de postagens
            }
        } else {
            console.error('userId n√£o fornecido');
        }
    } else {
        console.error('Cont√™iner de postagens n√£o encontrado');
    }
};

// Fun√ß√£o para carregar e exibir postagens da timelineLux
function exibirPostagens() {
    const timelinePostsDiv = document.getElementById('userPosts'); // A se√ß√£o correta para postagens
    timelinePostsDiv.innerHTML = ''; // Limpa conte√∫do atual para evitar duplicatas

    // Refer√™ncia para a cole√ß√£o timelineLux
    const timelineLuxRef = db.collection('timelineLux');

    // Consulta todas as postagens ordenadas por timestamp (mais recente primeiro)
    timelineLuxRef.orderBy('timestamp', 'desc').get()
        .then(async (querySnapshot) => {
            for (const doc of querySnapshot.docs) {
                const postData = doc.data();
                postData.id = doc.id; // Adiciona o ID do documento aos dados da postagem

                const postElement = await criarElementoPost(postData); // Fun√ß√£o que cria o elemento do post
                timelinePostsDiv.appendChild(postElement);
            }
        })
        .catch((error) => {
            console.error('Erro ao buscar postagens:', error);
        });
}


function openConfirmationModal() {
    const modal = document.getElementById("confirmationModal");
    const albumName = window.confirmationData.albumId;
    const accessCost = window.confirmationData.accessCost;

    // Atualiza os dados no modal
    document.getElementById("album-name").textContent = `√Ålbum: ${albumName}`;
    document.getElementById("cost-info").textContent = `Custo: ${accessCost} pontos`;

    // Exibe o modal
    modal.style.display = "flex"; // Exibe o modal
}



function viewAlbum(userId, albumId) {
    const albumModal = document.getElementById('albumModal');
    
    if (!albumModal) {
        alert('Erro: Modal n√£o encontrado!');
        return;
    }

    // Refer√™ncia ao √°lbum no Firestore
    const albumRef = db.collection('users').doc(userId).collection('MeusAlbums').doc(albumId);
    albumRef.get().then(async (albumDoc) => {
        if (albumDoc.exists) {
            const albumData = albumDoc.data();

            // Atribui o nome do √°lbum
            const albumName = albumData.albumName || "√Ålbum Sem Nome";
            const albumImages = await loadImagesForAlbum(userId, albumId);  // Carrega as imagens para o √°lbum

            // Preenche o nome do √°lbum no modal
            const modalTitle = albumModal.querySelector('.modal-title');
            modalTitle.textContent = albumName;

            // Limpa o conte√∫do anterior
            const albumContent = albumModal.querySelector('.modal-body');
            albumContent.innerHTML = '';  // Limpa o conte√∫do do modal

            // Verifica se h√° imagens e adiciona ao modal
            if (albumImages && albumImages.length > 0) {
                albumImages.forEach((imageUrl) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = imageUrl;
                    imgElement.alt = "Imagem do √°lbum";  // Descri√ß√£o alternativa para a imagem
                    imgElement.classList.add('album-image');  // Classe CSS para estilo das imagens
                    albumContent.appendChild(imgElement);
                });
            } else {
                const noImagesMessage = document.createElement('p');
                noImagesMessage.textContent = "Este √°lbum n√£o cont√©m imagens.";
                albumContent.appendChild(noImagesMessage);
            }

            // Exibe o modal
            albumModal.style.display = 'block';
        } else {
            alert('√Ålbum n√£o encontrado');
        }
    }).catch((error) => {
        console.error('Erro ao carregar o √°lbum:', error);
        alert('Erro ao carregar o √°lbum');
    });
}


async function grantAlbumAccess(userId, albumId, accessCost) {
    const userRef = db.collection('users').doc(userId);
    const userDoc = await userRef.get();

    if (!userDoc.exists) return false; // Verifica se o usu√°rio existe

    const userData = userDoc.data();
    const userPoints = userData.points || 0; // Pega os pontos do usu√°rio

    // Refer√™ncia para o √°lbum
    const albumRef = db.collection('users').doc(userId).collection('MeusAlbums').doc(albumId);
    const albumDoc = await albumRef.get();

    if (!albumDoc.exists) return false; // Verifica se o √°lbum existe

    const albumData = albumDoc.data();
    const allowedUsers = albumData.allowedUsers || [];
    const albumOwnerId = albumData.ownerId; // Dono do √°lbum

    // Se o usu√°rio j√° tem acesso, n√£o faz mais nada
    if (allowedUsers.includes(userId)) {
        return true; // Acesso j√° concedido anteriormente
    }

    // Se o usu√°rio for o dono do √°lbum, n√£o debita pontos
    if (userId === albumOwnerId) {
        await albumRef.update({
            allowedUsers: firebase.firestore.FieldValue.arrayUnion(userId) // Concede acesso ao dono
        });
        alert("Voc√™ √© o dono do √°lbum, acesso concedido sem debitar pontos!");
        return true;
    }

    // Verifica se o usu√°rio tem pontos suficientes
    if (userPoints >= accessCost) {
        // Debita pontos do usu√°rio
        await userRef.update({ points: userPoints - accessCost });

        // Adiciona o usu√°rio √† lista de allowedUsers
        await albumRef.update({
            allowedUsers: firebase.firestore.FieldValue.arrayUnion(userId) // Concede acesso ao √°lbum
        });

        // Exibe a mensagem de sucesso
        showSuccessMessage("Pontos debitados com sucesso! Acesso concedido.");

        // Exibe o modal de parabeniza√ß√£o
        showCongratulationsModal();

        return true;
    } else {
        // Exibe a mensagem de erro
        showErrorMessage("Pontos insuficientes para acessar este √°lbum.");
        return false;
    }
}

function closeModal() {
    const albumModal = document.getElementById('albumModal');
    albumModal.style.display = 'none'; // Esconde o modal
}




// Fun√ß√£o para buscar a capa do √°lbum diretamente do √°lbum do usu√°rio em 'MeusAlbums'
async function getAlbumCover(userId, albumId) {
    const photosSnapshot = await db.collection('users').doc(userId)
        .collection('MeusAlbums').doc(albumId)
        .collection('Imagens').limit(1).get();
    
    if (!photosSnapshot.empty) {
        const photoData = photosSnapshot.docs[0].data();
        return photoData.imageUrl || "https://via.placeholder.com/150";
    }
    return "https://via.placeholder.com/150"; // Retorna uma imagem padr√£o se n√£o houver fotos no √°lbum
}

// Fun√ß√£o para calcular a idade a partir da data de nascimento
function calculateAge(dateOfBirth) {
    const birthDate = new Date(dateOfBirth);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDifference = today.getMonth() - birthDate.getMonth();
    if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}


// Fun√ß√£o para expandir a imagem
function expandImage(imageUrl) {
    const overlay = document.getElementById("imageOverlay");
    const overlayImage = document.getElementById("overlayImage");
    overlayImage.src = imageUrl;
    overlay.style.display = "flex"; // Mostra o overlay
}

// Fun√ß√£o para fechar o overlay
function closeOverlay() {
    const overlay = document.getElementById("imageOverlay");
    overlay.style.display = "none";
}


function closeProfileModal() {
    document.getElementById("profileModal").style.display = "none";
}


// Renderiza as miniaturas na galeria do perfil
function renderProfileThumbnail(imageUrl, imageName) {
    const profileGallery = document.getElementById('profileGallery');
    const colDiv = document.createElement('div');
    colDiv.classList.add('col');

    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = imageName;
    img.classList.add('thumbnail');
    img.onclick = () => openImageModal(imageUrl, imageName);

    colDiv.appendChild(img);
    profileGallery.appendChild(colDiv);
    console.log('Imagem renderizada na galeria:', imageUrl);
}

// Fun√ß√£o para carregar imagens de um √°lbum espec√≠fico
async function loadImagesForAlbum(userId, albumId) {
    const images = [];  // Array para armazenar URLs das imagens
    try {
        const imagesSnapshot = await db.collection('users')
            .doc(userId)  // Usar o userId do dono do √°lbum
            .collection('MeusAlbums')
            .doc(albumId)
            .collection('Imagens')
            .get();

        imagesSnapshot.forEach(doc => {
            const imageData = doc.data();
            const imageUrl = imageData.imageUrl;
            if (imageUrl) {
                images.push(imageUrl);  // Adiciona a URL da imagem ao array
            }
        });
    } catch (error) {
        console.error('Erro ao carregar imagens do √°lbum:', error);
    }

    return images;  // Retorna o array com as imagens
}

// Fun√ß√£o para abrir a imagem em um modal (caso n√£o esteja definida)
function openImageModal(imageUrl) {
    const modal = document.getElementById('myimagemodal');
    const modalImg = document.getElementById('modalImage');

    modal.style.display = 'block';
    modalImg.src = imageUrl;
}


async function criarElementoPost(postData) {
    const postElement = document.createElement('div');
    postElement.className = 'post'; // Adicione classes ou estilos conforme necess√°rio

    // Adicione conte√∫do ao post
    postElement.innerHTML = `
        <h4>${postData.autorNome}</h4>
        <p>${postData.texto}</p>
        <img src="${postData.postImageUrl}" alt="Imagem do Post" />
        <p>${postData.timestamp ? postData.timestamp.toDate().toLocaleString() : ''}</p>
    `;

    return postElement; // Retorna o elemento da postagem
}


function openTab(event, tabId) {
    // Oculta todas as abas
    const tabContents = document.getElementsByClassName('tab-content');
    for (let tab of tabContents) {
        tab.style.display = 'none'; // Oculta cada aba
    }

    // Remove a classe 'active' de todos os bot√µes
    const tabLinks = document.getElementsByClassName('tab-link');
    for (let link of tabLinks) {
        link.classList.remove('active'); // Remove a classe 'active' de cada bot√£o
    }

    // Mostra a aba selecionada
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.style.display = 'block'; // Mostra a aba selecionada
    } else {
        console.error(`Elemento com ID "${tabId}" n√£o encontrado.`);
    }

    // Adiciona a classe 'active' ao bot√£o clicado
    event.currentTarget.classList.add('active');
}







// Fun√ß√µes para carregar o conte√∫do das abas
function loadTimeline(userId) {
    console.log(`Carregar timeline do usu√°rio: ${userId}`);
}

function loadAbout(userData) {
    console.log("Carregar detalhes do usu√°rio", userData);
}

function loadPhotos(userId) {
    console.log(`Carregar fotos do usu√°rio: ${userId}`);
}

// Obt√©m o ID do usu√°rio a partir da URL e carrega o perfil
const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");

if (userId) {
    loadUserProfile(userId);
} else {
    console.error("ID do usu√°rio n√£o fornecido.");
}


function startChat(userId, userName) {
    console.log(`Iniciando conversa com o usu√°rio ${userId}`);

    // Abre o chatbox para a conversa com o usu√°rio
    openChatbox(userId, userName);
    
    // L√≥gica adicional, como carregar o hist√≥rico de conversas, etc.
}

function closeChatbox() {
    const chatbox = document.getElementById('chatbox');
    chatbox.style.display = 'none'; // Oculta o chatbox
}




notificationBell.onclick = async () => {
  const currentUser = firebase.auth().currentUser;

  if (!currentUser) {
    console.error("Usu√°rio n√£o autenticado");
    return;
  }

  const userId = currentUser.uid;

  // Limpa a lista de conversas antes de preench√™-la
  conversationsContainer.innerHTML = '';

  // Busca todas as conversas que o usu√°rio participa
  const conversasRef = firebase.firestore().collection('conversas');
  const querySnapshot = await conversasRef
    .where('participantes', 'array-contains', userId)
    .get();

  let hasUnreadMessages = false;

  // Fun√ß√£o para buscar o nome do usu√°rio
  const fetchUserName = async (userId) => {
    if (!userId) {
      console.error("ID de usu√°rio inv√°lido");
      return "Usu√°rio Desconhecido";
    }
    const userDoc = await firebase.firestore().collection('usuarios').doc(userId).get();
    console.log(`Buscando nome para o ID: ${userId}`); // Debugging
    if (userDoc.exists) {
      console.log(`Nome encontrado: ${userDoc.data().name}`); // Debugging
      return userDoc.data().name; // Retorna o nome do usu√°rio
    } else {
      console.error(`Documento n√£o encontrado para o ID: ${userId}`); // Debugging
      return "Usu√°rio Desconhecido"; // Ajuste conforme sua estrutura
    }
  };

  for (const doc of querySnapshot.docs) {
    const data = doc.data();

    // Verifica se h√° mensagens n√£o vistas
    if (!data.visto) {
      const otherUserId = data.participantes.find(id => id !== userId);
      const otherUserName = await fetchUserName(otherUserId); // Fetch o nome do outro usu√°rio

      // Cria um elemento para a conversa
      const conversationElement = document.createElement('div');
      conversationElement.classList.add('conversation');
      conversationElement.innerHTML = `<strong>${otherUserName}</strong>`;

      // Adiciona um evento de clique para abrir o chatbox correspondente
      conversationElement.onclick = () => {
        loadMessages(otherUserId); // Carrega as mensagens ao abrir o chatbox
        const chatbox = document.getElementById('chatbox');
        chatbox.style.display = 'block'; // Mostra o chatbox
        conversationsList.style.display = 'none'; // Esconde a lista de conversas
      };

      conversationsContainer.appendChild(conversationElement);
      hasUnreadMessages = true;
    }
  }

  // Exibe a lista de conversas se houver mensagens n√£o lidas
  if (hasUnreadMessages) {
    conversationsList.style.display = 'block';
  } else {
    console.log("N√£o h√° novas mensagens.");
    conversationsList.style.display = 'none'; // Esconde se n√£o houver mensagens
  }
};

async function sendImageMessage() {
    const fileInput = document.getElementById('image-input');
    const file = fileInput.files[0];

    if (!file) {
        console.error("Nenhuma imagem selecionada.");
        return;
    }

    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        console.error("Usu√°rio n√£o autenticado.");
        return;
    }

    const currentUserId = currentUser.uid;
    const chatbox = document.getElementById('chatbox');
    const userId = chatbox.getAttribute('data-user-id');

    if (!userId) {
        console.error("Erro ao identificar o ID do usu√°rio destino.");
        return;
    }

    const conversaId = await getOrCreateConversaId(currentUserId, userId);

    try {
        // Enviar a imagem para o Firebase Storage
        const storageRef = firebase.storage().ref();
        const imageRef = storageRef.child(`conversas/${conversaId}/${Date.now()}_${file.name}`);
        const snapshot = await imageRef.put(file);

        const imageUrl = await snapshot.ref.getDownloadURL();
        console.log("Imagem carregada:", imageUrl);

        // Salvar a URL da imagem no Firestore como uma mensagem
        const mensagensRef = firebase.firestore().collection('conversas').doc(conversaId).collection('mensagens');
        await mensagensRef.add({
            remetenteId: currentUserId,
            remetenteNome: currentUser.displayName || "Usu√°rio",
            destinatarioId: userId,
            imagemUrl: imageUrl,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            visto: false,
        });

        console.log("Imagem enviada e salva como mensagem.");

        // Limpar pr√©-visualiza√ß√£o e campo de sele√ß√£o
        document.getElementById('image-preview-container').style.display = 'none';
        document.getElementById('image-input').value = '';
    } catch (error) {
        console.error("Erro ao enviar imagem:", error);
    }
}
function handleImageSelection(event) {
    const file = event.target.files[0];
    if (file) {
        const preview = document.getElementById('image-preview');
        const reader = new FileReader();
        reader.onload = () => {
            preview.src = reader.result;
            document.getElementById('image-preview-container').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}
function renderMessage(message) {
    const chatboxMessages = document.getElementById('chatbox-messages');
    const messageElement = document.createElement('div');

    // Define a classe com base no remetente
    messageElement.classList.add('message');
    messageElement.classList.add(
        message.remetenteId === firebase.auth().currentUser.uid ? 'sent' : 'received'
    );

    if (message.texto) {
        // Mensagem de texto
        const textElement = document.createElement('p');
        textElement.textContent = message.texto;
        textElement.style.margin = '0';
        messageElement.appendChild(textElement);
    } else if (message.imagemUrl) {
        // Mensagem de imagem
        const imgElement = document.createElement('img');
        imgElement.src = message.imagemUrl;
        imgElement.alt = 'Imagem enviada';
        imgElement.style.maxWidth = '100%';
        imgElement.style.borderRadius = '8px';
        imgElement.style.marginTop = '5px';
        messageElement.appendChild(imgElement);
    } else {
        console.warn("Mensagem recebida sem texto ou imagem:", message);
    }

    // Adicionar a mensagem ao chatbox
    chatboxMessages.appendChild(messageElement);
    chatboxMessages.scrollTop = chatboxMessages.scrollHeight; // Rola para a √∫ltima mensagem
}
function listenForMessages(conversaId) {
    const mensagensRef = firebase.firestore()
        .collection('conversas')
        .doc(conversaId)
        .collection('mensagens')
        .orderBy('timestamp', 'asc');

    mensagensRef.onSnapshot((snapshot) => {
        const chatboxMessages = document.getElementById('chatbox-messages');
        chatboxMessages.innerHTML = ''; // Limpa mensagens antigas antes de renderizar

        snapshot.forEach((doc) => {
            const message = doc.data();
            renderMessage(message);
        });
    });
}


function sendAudio() {
    alert("Fun√ß√£o para enviar √°udio");
}



function sendGift() {
    alert("Fun√ß√£o para enviar presente");
}



// Fun√ß√£o para fechar o chatbox
function closeChatbox() {
  const chatbox = document.getElementById('chatbox');
  chatbox.style.display = 'none'; // Esconde o chatbox
}


// Fun√ß√£o para buscar o nome do usu√°rio com base no ID
async function fetchUserName(userId) {
  const userDoc = await firebase.firestore().collection('users').doc(userId).get();
  return userDoc.exists ? userDoc.data().name : 'Usu√°rio desconhecido';
}

async function openChatbox(userId, userName) {
  const chatbox = document.getElementById('chatbox');
  const chatboxUsername = document.getElementById('chatbox-username');

  chatbox.style.display = 'block';
  chatbox.setAttribute('data-user-id', userId); // Define o userId como atributo do chatbox
  chatbox.setAttribute('data-user-name', userName); // Define o userName como atributo do chatbox

  try {
    const userDoc = await firebase.firestore().collection('users').doc(userId).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      chatboxUsername.innerText = `Conversa com ${userData.name}`;
    } else {
      chatboxUsername.innerText = 'Usu√°rio desconhecido';
    }
  } catch (error) {
    chatboxUsername.innerText = 'Erro ao carregar usu√°rio';
    console.error("Erro ao carregar informa√ß√µes do usu√°rio:", error);
  }

  loadMessages(userId); // Carrega as mensagens da conversa
}


const activeListeners = {}; // Armazena listeners ativos para cada conversa




async function loadMessages(userId) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;

    const currentUserId = currentUser.uid;
    const conversaId = await getOrCreateConversaId(currentUserId, userId);

    const chatbox = document.getElementById('chatbox');
    const chatboxMessages = document.getElementById('chatbox-messages');
    chatboxMessages.innerHTML = '';

    // Verifica se j√° existe um listener ativo para esta conversa e remove-o
    if (activeListeners[conversaId]) {
        activeListeners[conversaId](); // Desativa o listener anterior
    }

    // Configura o novo listener e salva sua refer√™ncia em activeListeners
    activeListeners[conversaId] = firebase.firestore()
        .collection('conversas')
        .doc(conversaId)
        .collection('mensagens')
        .orderBy('timestamp')
        .onSnapshot(async (snapshot) => {
            chatboxMessages.innerHTML = ''; // Limpa antes de exibir

            for (const doc of snapshot.docs) {
                const messageData = doc.data();

                // Atualiza para visto se a mensagem for recebida
                if (messageData.remetenteId !== currentUserId && !messageData.visto) {
                    doc.ref.update({ visto: true });
                }

                const senderName = messageData.remetenteId === currentUserId 
                    ? "Voc√™" 
                    : await fetchUserName(messageData.remetenteId);

                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(messageData.remetenteId === currentUserId ? 'sent' : 'received');
                messageElement.innerHTML = `<strong>${senderName}:</strong> ${messageData.texto}`;

                chatboxMessages.appendChild(messageElement);
            }
            chatboxMessages.scrollTop = chatboxMessages.scrollHeight;
        });
}


function closeChat() {
    const chatbox = document.getElementById('chatbox');
    const conversaId = chatbox.getAttribute('data-conversa-id');

    if (conversaId && activeListeners[conversaId]) {
        activeListeners[conversaId](); // Remove o listener ativo para esta conversa
        delete activeListeners[conversaId]; // Limpa o listener do objeto
    }

    chatbox.style.display = 'none';
}

async function sendChatMessage() {
    const messageInput = document.getElementById('chatbox-input-message');
    const text = messageInput.value.trim();

    if (!text) {
        console.warn("Mensagem vazia, n√£o ser√° enviada.");
        return; // Verifica se o texto da mensagem n√£o est√° vazio
    }

    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        console.error("Usu√°rio n√£o autenticado");
        return;
    }

    const currentUserId = currentUser.uid;

    const chatbox = document.getElementById('chatbox');
    const userId = chatbox.getAttribute('data-user-id'); // Obt√©m o userId do atributo data

    if (!userId) {
        console.error("Erro ao identificar o ID do usu√°rio destino");
        return;
    }

    const conversaId = await getOrCreateConversaId(currentUserId, userId);
    if (!conversaId) {
        console.error("Erro ao obter ou criar ID da conversa");
        return;
    }

    const mensagensRef = firebase.firestore().collection('conversas').doc(conversaId).collection('mensagens');
    try {
        // Adiciona o nome do remetente ao enviar a mensagem
        await mensagensRef.add({
            remetenteId: currentUserId,
            remetenteNome: currentUser.displayName || "Usu√°rio", // Nome do remetente
            destinatarioId: userId, // Adicione o destinat√°rio
            texto: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            visto: false // Marca a mensagem como n√£o lida
        });
        console.log("Mensagem enviada para a cole√ß√£o 'mensagens':", text);

        // Atualiza a subcole√ß√£o de conversas para o usu√°rio atual
        const currentUserConversationsRef = firebase.firestore().collection('users').doc(currentUserId).collection('conversas').doc(userId);
        console.log("Atualizando a subcole√ß√£o de conversas para o usu√°rio atual:", currentUserId);
        await currentUserConversationsRef.set({
            lastMessage: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true }); // Usa merge para n√£o sobrescrever dados existentes

        // Atualiza a subcole√ß√£o de conversas para o amigo
        const friendConversationsRef = firebase.firestore().collection('users').doc(userId).collection('conversas').doc(currentUserId);
        console.log("Atualizando a subcole√ß√£o de conversas para o amigo:", userId);
        await friendConversationsRef.set({
            lastMessage: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });

        // Limpa o campo de texto ap√≥s enviar
        messageInput.value = ''; 

        // Atualiza o cart√£o do usu√°rio com a √∫ltima mensagem
        updateMatchCard(userId);
    } catch (error) {
        console.error("Erro ao enviar mensagem:", error);
    }
}


let pendingOffer = null; // Vari√°vel global


let localStream; // Stream do usu√°rio local
const config = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // STUN gratuito do Google
};

async function startVideoCall() {
    try {
        const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

        // Exibe o v√≠deo local
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        ensurePeerConnection(); // Inicializa peerConnection

        // Adiciona o stream local
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Cria e envia uma oferta
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        sendSignalingMessage({ offer });
    } catch (error) {
        console.error('[ERROR] Erro ao iniciar a chamada de v√≠deo:', error);
    }
}

function endCall() {
    if (!peerConnection) {
        console.error('[ERROR] peerConnection n√£o foi inicializado.');
        return;
    }

    // Fecha a conex√£o
    peerConnection.close();
    peerConnection = null;

    // Limpa v√≠deos
    document.getElementById('localVideo').srcObject = null;
    document.getElementById('remoteVideo').srcObject = null;

    console.log('[INFO] Chamada encerrada.');
}


// Enviar mensagem de sinaliza√ß√£o para o Firebase
function sendSignalingMessage(data) {
    const signalingRef = firebase.database().ref('signaling/roomId');
    signalingRef.push(data);
}

// Receber mensagens de sinaliza√ß√£o do Firebase
firebase.database().ref('signaling/roomId').on('child_added', (snapshot) => {
    const message = snapshot.val();
    handleSignalingMessage(message);
});
peerConnection.onsignalingstatechange = () => {
    console.log('[INFO] Estado da sinaliza√ß√£o atualizado:', peerConnection.signalingState);
};





let peerConnection = null; // Vari√°vel para armazenar a conex√£o P2P

async function handleSignalingMessage(message) {
    try {
        ensurePeerConnection();  // Verifique se a conex√£o est√° inicializada

        if (message.offer) {
            console.log('[INFO] Oferta recebida:', message.offer);

            if (peerConnection.signalingState !== 'stable') {
                console.warn('[WARN] Estado de sinaliza√ß√£o n√£o est√°vel. Armazenando oferta pendente.');
                pendingOffer = message.offer;  // Armazena a oferta para processar mais tarde
                return;
            }

            // Processa a oferta
            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
            console.log('[INFO] Oferta configurada como descri√ß√£o remota.');

            // Cria a resposta e envia para o outro peer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            console.log('[INFO] Resposta criada e configurada como descri√ß√£o local:', answer);

            sendSignalingMessage({ answer });
        } else if (message.answer) {
            console.log('[INFO] Resposta recebida:', message.answer);

            if (peerConnection.signalingState !== 'have-local-offer') {
                console.warn('[WARN] Estado de sinaliza√ß√£o inv√°lido para resposta. Ignorando.');
                return;
            }

            // Configura a descri√ß√£o remota com a resposta recebida
            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
            console.log('[INFO] Resposta configurada como descri√ß√£o remota.');
        } else if (message.candidate) {
            console.log('[INFO] Candidato ICE recebido:', message.candidate);

            // Adiciona o candidato ICE √† conex√£o
            await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            console.log('[INFO] Candidato ICE adicionado com sucesso.');
        }

        // Processa a oferta pendente, se houver
        if (pendingOffer && peerConnection.signalingState === 'stable') {
            console.log('[INFO] Processando oferta pendente.');
            const offer = pendingOffer;
            pendingOffer = null;  // Limpa a oferta pendente
            await handleSignalingMessage({ offer });
        }

    } catch (error) {
        console.error('[ERROR] Erro ao processar mensagem de sinaliza√ß√£o:', error);
    }
}

function ensurePeerConnection() {
    if (!peerConnection) {
        console.log('[INFO] Inicializando peerConnection.');
        peerConnection = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignalingMessage({ candidate: event.candidate });
            }
        };

        peerConnection.ontrack = (event) => {
            console.log('[INFO] Track recebido:', event.streams[0]);
            const remoteVideo = document.getElementById('remoteVideo');
            remoteVideo.srcObject = event.streams[0];
        };
    }
}



const updateMatchCard = async (userId) => {
    const currentUserId = firebase.auth().currentUser.uid;
    const conversaId = await getOrCreateConversaId(currentUserId, userId);
    const conversaDocRef = firebase.firestore().collection('conversas').doc(conversaId);

    const conversaDoc = await conversaDocRef.get();
    if (conversaDoc.exists) {
        const conversaData = conversaDoc.data();
        const ultimaMensagem = conversaData.lastMessage || "Sem mensagens ainda";

        console.log(`√öltima mensagem com ${userId}:`, ultimaMensagem);

        // Atualiza o card
        const matchCard = document.querySelector(`.user-card[data-user-id="${userId}"]`);
        if (matchCard) {
            const lastMessageElement = matchCard.querySelector('.last-message');

            if (ultimaMensagem === "üì∑ Imagem enviada") {
                lastMessageElement.innerHTML = `<span>üì∑ Imagem enviada</span>`;
            } else {
                lastMessageElement.textContent = ultimaMensagem; // Exibe texto
            }
        }
    }
};



async function listenForNewMessages(userId) {
  const conversaId = await getOrCreateConversaId(firebase.auth().currentUser.uid, userId);
  const mensagensRef = firebase.firestore().collection('conversas').doc(conversaId).collection('mensagens');

  mensagensRef.orderBy('timestamp').onSnapshot((snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added") {
        const messageData = change.doc.data();
        // Verifica se a mensagem √© nova e n√£o foi lida
        if (!messageData.visto && messageData.destinatarioId === firebase.auth().currentUser.uid) {
          // Ativa a notifica√ß√£o
          showNotification(messageData);
        }
      }
    });
  });
}

function showNotification(messageData) {
  const notificationBell = document.getElementById('notification-bell');
  
  // Adiciona a classe "active" para mudar a cor do sininho
  notificationBell.classList.add('active');

  // Adicione um ouvinte de clique para abrir o chatbox ao clicar no sininho
  notificationBell.onclick = function() {
    notificationBell.classList.remove('active'); // Remove a notifica√ß√£o
    openChatbox(messageData.remetenteId, messageData.remetenteNome); // Passar os par√¢metros corretos
  };
}

async function markMessagesAsRead(conversaId) {
  const mensagensRef = firebase.firestore().collection('conversas').doc(conversaId).collection('mensagens');
  const currentUser = firebase.auth().currentUser;
  if (!currentUser) return;

  await mensagensRef.where('destinatarioId', '==', currentUser.uid).where('visto', '==', false).get()
    .then((snapshot) => {
      snapshot.forEach((doc) => {
        mensagensRef.doc(doc.id).update({ visto: true });
      });
    });
}




async function getOrCreateConversaId(userId1, userId2) {
    // Ordena IDs para manter a consist√™ncia
    const conversaId = userId1 < userId2 ? `${userId1}_${userId2}` : `${userId2}_${userId1}`;

    const conversaRef = firebase.firestore().collection('conversas').doc(conversaId);
    const conversaDoc = await conversaRef.get();

    // Cria o documento se ele ainda n√£o existir
    if (!conversaDoc.exists) {
        await conversaRef.set({
            users: [userId1, userId2],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    return conversaId;
}

async function monitorNewMessages(conversaId, currentUserId) {
  const mensagensRef = firebase.firestore()
    .collection('conversas').doc(conversaId).collection('mensagens');

  mensagensRef
    .where('visto', '==', false)
    .where('destinatarioId', '==', currentUserId)
    .onSnapshot((snapshot) => {
      snapshot.forEach((doc) => {
        const messageData = doc.data();
        if (!messageData.visto) {
          displayNotification(messageData.texto, conversaId, messageData.remetenteId);
          // Atualiza o status de visto para true para que n√£o notifique repetidamente
          doc.ref.update({ visto: true });
        }
      });
    });
}
function displayNotification() {
  const notificationBell = document.getElementById('notification-bell');
  notificationBell.classList.add('new-message'); // Adiciona a classe para mudar a cor do sininho
}



async function removeMatch(matchedUserId) {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        console.log('Usu√°rio n√£o est√° logado.');
        return;
    }

    const currentUserId = currentUser.uid;

    try {
        // Atualiza o documento do usu√°rio atual para remover o match
        const userDocRef = db.collection('users').doc(currentUserId);
        await userDocRef.update({
            Matches: firebase.firestore.FieldValue.arrayRemove(matchedUserId) // Remove o matchedUserId da array Matches
        });

        // Tamb√©m atualiza o documento do usu√°rio que foi removido do match
        const matchedUserDocRef = db.collection('users').doc(matchedUserId);
        await matchedUserDocRef.update({
            Matches: firebase.firestore.FieldValue.arrayRemove(currentUserId) // Remove o currentUserId da array Matches do outro usu√°rio
        });

        // L√≥gica para remover o card do usu√°rio da lista de matches
        const matchesList = document.getElementById('matches');
        const matchedUserCard = matchesList.querySelector(`.user-card[data-user-id="${matchedUserId}"]`);
        if (matchedUserCard) {
            matchedUserCard.remove(); // Remove o card da lista de "Meus Matches"
        }

        console.log(`Match com ${matchedUserId} removido com sucesso.`);

    } catch (error) {
        console.error('Erro ao remover o match:', error);
    }
}


// Fun√ß√£o para exibir mensagem caso ningu√©m tenha curtido
function displayNoLikesMessage() {
  const likedUsersList = document.getElementById('liked-users-list');
  likedUsersList.innerHTML = '<p>Ningu√©m curtiu voc√™ ainda.</p>';
}

async function fetchRandomUsers() {
    const usersRef = firebase.firestore().collection('users');
    const snapshot = await usersRef.get();

    // Verifica se h√° documentos
    if (!snapshot.empty) {
        const users = [];

        // Adiciona todos os usu√°rios em um array
        snapshot.forEach(doc => {
            let userData = doc.data();
            userData.id = doc.id; // Adiciona o ID do documento aos dados do usu√°rio
            users.push(userData);
        });

        // Embaralhar os usu√°rios aleatoriamente
        const shuffledUsers = users.sort(() => Math.random() - 0.5);

        // Limita a exibi√ß√£o para um n√∫mero m√°ximo de usu√°rios (por exemplo, 5)
        const maxUsersToShow = 15;
        const usersToShow = shuffledUsers.slice(0, maxUsersToShow);

        console.log('Usu√°rios a serem exibidos:', usersToShow); // Debugging
        // Atualiza o HTML com os usu√°rios
        displayRandomUsers(usersToShow);
    } else {
        console.log('Nenhum usu√°rio encontrado');
    }
}

function calculateAge(dateOfBirth) {
    const birthDate = new Date(dateOfBirth);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}

function displayRandomUsers(users) {
    const randomUsersList = document.getElementById('random-users-list');
    randomUsersList.innerHTML = ''; // Limpa a lista antes de adicionar os usu√°rios

    users.forEach(user => {
        const userCard = document.createElement('div');
        userCard.classList.add('user-card');

        // Calcular idade com base na data de nascimento
        const age = user.dateOfBirth ? calculateAge(user.dateOfBirth) : 'N√£o informado';

        // Define o conte√∫do do card com os dados b√°sicos do usu√°rio
        userCard.innerHTML = `
            <img src="${user.profilePhotoURL || 'https://via.placeholder.com/100'}" alt="${user.name}" class="small-photo">
            <p class="user-name">${user.name}, ${age}</p>
            <button class="like-btn" data-user-id="${user.id}">
                ‚ù§Ô∏è Curtir
            </button>
            <!-- Div para informa√ß√µes adicionais, inicialmente oculta -->
            <div class="user-details" style="display: none;">
                <p>Cidade: ${user.cidade || 'N√£o informado'}</p>
                <p>Idade: ${age}</p>
                <p>Tipo: ${user.tipouser || 'N√£o informado'}</p>
            </div>
        `;

        // Evento de clique para alternar entre expandir e recolher
        userCard.addEventListener('click', () => {
            const userDetails = userCard.querySelector('.user-details');
            userDetails.style.display = userDetails.style.display === 'none' ? 'block' : 'none';
            userCard.classList.toggle('expanded-card'); // Alterna a classe para estilo expandido
        });

        // Adiciona o card √† lista
        randomUsersList.appendChild(userCard);
    });

    // Adiciona evento de clique aos bot√µes de curtir
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation(); // Evita que o clique no bot√£o expanda o card
            const likedUserId = e.target.getAttribute('data-user-id'); // Captura o ID do usu√°rio curtido
            handleLikeUser(likedUserId); // Chama a fun√ß√£o para curtir o usu√°rio
        });
    });
}

document.getElementById('advancedSearchForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        alert("Voc√™ precisa estar logado para realizar a pesquisa.");
        return;
    }

    const userRef = db.collection('users').doc(currentUser.uid);
    const userDoc = await userRef.get();
    const userData = userDoc.data();

    const isVip = userData.vip || false; // Verifica se o usu√°rio √© VIP
    const userPoints = parseInt(userData.points || 0, 10);

    if (isVip || userPoints >= 5) {
        // Exibe o modal para confirmar a pesquisa
        showModalVerifySearch(isVip, userPoints, () => executeAdvancedSearch());
    } else {
        alert("Voc√™ n√£o tem pontos suficientes para realizar a pesquisa.");
    }
});
function showModalVerifySearch(isVip, userPoints, onConfirm) {
    const modal = document.getElementById('modalVerifySearch');
    modal.style.display = 'flex';

    // Configura os bot√µes do modal
    document.getElementById('confirmSearch').onclick = async () => {
        if (!isVip) {
            // Debita 5 pontos do usu√°rio
            const currentUser = firebase.auth().currentUser;
            const userRef = db.collection('users').doc(currentUser.uid);
            await userRef.update({
                points: firebase.firestore.FieldValue.increment(-5),
            });
        }

        modal.style.display = 'none'; // Fecha o modal
        onConfirm(); // Executa a pesquisa
    };

    document.getElementById('becomeVip').onclick = () => {
        alert("Redirecionando para assinar o plano VIP...");
        modal.style.display = 'none'; // Fecha o modal
        // Redirecionar para a p√°gina de assinatura VIP
        window.location.href = '/vip-plan';
    };

    document.getElementById('cancelSearch').onclick = () => {
        modal.style.display = 'none'; // Fecha o modal
    };
}

// Fun√ß√£o que executa a pesquisa ap√≥s a confirma√ß√£o
function executeAdvancedSearch() {
    const cidade = document.getElementById('cidade').value.trim();
    const email = document.getElementById('email').value.trim();
    const gender = document.getElementById('gender').value;
    const income = document.getElementById('income').value;
    const name = document.getElementById('name').value.trim();
    const tipouser = document.getElementById('tipouser').value;
    const minAge = parseInt(document.getElementById('minAge').value, 10);
    const maxAge = parseInt(document.getElementById('maxAge').value, 10);

    let query = db.collection('users');

    if (cidade) query = query.where('cidade', '==', cidade);
    if (email) query = query.where('email', '==', email);
    if (gender) query = query.where('gender', '==', gender);
    if (income) query = query.where('income', '==', income);
    if (name) query = query.where('name', '==', name);
    if (tipouser) query = query.where('tipouser', '==', tipouser);

    if (minAge || maxAge) {
        const today = new Date();
        const maxDateOfBirth = new Date(today.getFullYear() - (minAge || 18), today.getMonth(), today.getDate());
        const minDateOfBirth = new Date(today.getFullYear() - (maxAge || 80), today.getMonth(), today.getDate());

        if (minAge) query = query.where('dateOfBirth', '<=', maxDateOfBirth.toISOString().split('T')[0]);
        if (maxAge) query = query.where('dateOfBirth', '>=', minDateOfBirth.toISOString().split('T')[0]);
    }

    query.get().then((querySnapshot) => {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = ''; // Limpa os resultados anteriores

        if (querySnapshot.empty) {
            resultsContainer.innerHTML = '<p>Nenhum usu√°rio encontrado.</p>';
        } else {
            querySnapshot.forEach((doc) => {
                const user = doc.data();

                // Criar o card para o usu√°rio encontrado
                const card = document.createElement('div');
                card.classList.add('user-card');

                // Adiciona as informa√ß√µes do usu√°rio e os bot√µes
                card.innerHTML = `
                    <div class="user-details">
                        <img src="${user.profilePhotoURL || 'default-photo.jpg'}" alt="Foto do Usu√°rio" class="user-photo">
                        <h3>${user.name}</h3>
                        <p><strong>Cidade:</strong> ${user.cidade || 'N√£o especificado'}</p>
                        <p><strong>Idade:</strong> ${calculateAge(user.dateOfBirth) || 'N/A'}</p>
                        <p><strong>Renda:</strong> ${user.income || 'N√£o especificado'}</p>
                        <div class="user-actions">
                            <button class="like-btn" data-user-id="${user.userId}">Curtir ‚ù§Ô∏è</button>
                            <button class="view-profile-btn" onclick="viewProfile('${user.userId}')">üëÅÔ∏è Ver Perfil</button>
                            <button class="add-friend-btn" data-user-id="${user.userId}">üíô Adicionar aos amigos</button>
                        </div>
                    </div>
                `;

                // Adiciona o card ao container de resultados
                resultsContainer.appendChild(card);
            });

            // Adiciona evento de clique aos bot√µes de curtir e adicionar amigo ap√≥s a renderiza√ß√£o dos cards
            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const likedUserId = e.target.getAttribute('data-user-id');
                    handleLikeUser(likedUserId);
                });
            });

            document.querySelectorAll('.add-friend-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    await handleAddFriend(userId, e.target);
                });
            });
        }
    }).catch((error) => {
        console.error('Erro ao buscar usu√°rios:', error);
        alert('Erro ao buscar usu√°rios: ' + error.message);
    });
}

async function fetchNotifications() {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado.');
        return;
    }

    const currentUserId = currentUser.uid;
    const notificationsContainer = document.getElementById('notificationsContainer'); // Certifique-se de que esse elemento exista

    // Limpa as notifica√ß√µes anteriores
    notificationsContainer.innerHTML = '';

    try {
        const notificationsSnapshot = await db.collection('users').doc(currentUserId)
            .collection('notifications')
            .orderBy('timestamp', 'desc') // Ordena as notifica√ß√µes mais recentes primeiro
            .get();

        if (notificationsSnapshot.empty) {
            notificationsContainer.innerHTML = '<p>Sem notifica√ß√µes.</p>';
            return;
        }

        notificationsSnapshot.forEach((doc) => {
            const notification = doc.data();
            const notificationElement = document.createElement('div');
            notificationElement.classList.add('notification'); // Adicione estilos conforme necess√°rio
            notificationElement.innerText = notification.message;
            notificationsContainer.appendChild(notificationElement);
        });
    } catch (error) {
        console.error('Erro ao buscar notifica√ß√µes:', error);
    }
}

firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        fetchNotifications(); // Chama a fun√ß√£o para buscar notifica√ß√µes
    }
});

async function fetchLikedUsers() {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        console.log('Usu√°rio n√£o est√° logado.');
        return;
    }

    const currentUserId = currentUser.uid;
    const likedUsersList = document.getElementById('liked-users-list'); // Ajuste conforme seu HTML

    likedUsersList.innerHTML = ''; // Limpa a lista anterior

    try {
        console.log('Buscando dados do usu√°rio...');
        const userDocRef = db.collection('users').doc(currentUserId);
        const userDoc = await userDocRef.get();

        if (userDoc.exists) {
            const userData = userDoc.data();
            const likedUsers = userData.MeusLikes || []; // Obt√©m a lista de curtidas

            console.log('Usu√°rios curtidos encontrados:', likedUsers);
            if (likedUsers.length === 0) {
                // Exibe mensagem se n√£o houver curtidas
                likedUsersList.innerHTML = '<p>Voc√™ n√£o tem nenhuma curtida no momento.</p>';
            } else {
                for (const likedUserId of likedUsers) {
                    const likedUserDoc = await db.collection('users').doc(likedUserId).get();
                    if (likedUserDoc.exists) {
                        const likedUserData = likedUserDoc.data();
                        const userCard = createUserCard(likedUserData); // Chama a fun√ß√£o modificada
                        likedUsersList.appendChild(userCard);
                    }
                }
            }
        } else {
            console.log('Documento do usu√°rio atual n√£o encontrado.');
            likedUsersList.innerHTML = '<p>Voc√™ n√£o curtiu ningu√©m ainda.</p>';
        }
    } catch (error) {
        console.error('Erro ao buscar usu√°rios curtidos:', error);
    }
}



// Carrega a lista de curtidas quando o usu√°rio estiver autenticado e a p√°gina for carregada
firebase.auth().onAuthStateChanged(user => {
    if (user) {
        fetchLikedUsers(); // Carrega a lista de curtidas do usu√°rio
    }
});

firebase.auth().onAuthStateChanged(user => {
    if (user) {
        startMessageListener(user.uid);
    }
});


// Fun√ß√£o para mostrar op√ß√µes de busca por 'Interessado em'
function showLookingForOptions() {
  const preferencesForm = document.getElementById('preferencesForm');
  const gender = preferencesForm.elements['gender'].value;
  const interestIn = preferencesForm.elements['interestIn'].value;

  // Verifica se ambos os campos foram selecionados
  if (gender && interestIn) {
    // Mostra o bot√£o de busca
    document.getElementById('searchButton').style.display = 'inline-block';
  } else {
    alert('Por favor, selecione o g√™nero e o interesse para prosseguir.');
  }
}



// Fun√ß√£o para preencher o campo de sele√ß√£o de cidades no formul√°rio de prefer√™ncias
function populateCitiesSelect() {
  const cidadeSelect = document.getElementById('cidadeFilter');

  // Limpa as op√ß√µes atuais do select
  cidadeSelect.innerHTML = '<option value="">Selecione...</option>';

  // Consulta as cidades no Firestore
  db.collection('users').get()
    .then((querySnapshot) => {
      const citiesSet = new Set();

      querySnapshot.forEach((doc) => {
        const cidade = doc.data().cidade;
        if (cidade) {
          citiesSet.add(cidade); // Adiciona a cidade ao conjunto para garantir cidades √∫nicas
        }
      });

      // Converte o conjunto de cidades para um array e ordena alfabeticamente
      const citiesArray = Array.from(citiesSet).sort();

      // Adiciona as op√ß√µes ao select
      citiesArray.forEach((cidade) => {
        const option = document.createElement('option');
        option.textContent = cidade;
        option.value = cidade;
        cidadeSelect.appendChild(option);
      });
    })
    .catch((error) => {
      console.error('Erro ao buscar cidades: ', error);
      alert('Ocorreu um erro ao buscar as cidades.');
    });
}

// Chama a fun√ß√£o para preencher o select de cidades ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', () => {
  populateCitiesSelect();
});


// Esperar at√© que o DOM esteja completamente carregado
document.addEventListener('DOMContentLoaded', (event) => {
  // Agora podemos acessar os elementos do DOM com seguran√ßa
  const searchButton = document.getElementById('searchButton');
  if (searchButton) {
    searchButton.addEventListener('click', searchPotentialPartners);
  } else {
    console.error('Bot√£o de busca n√£o encontrado.');
  }
  
  
});



// Fun√ß√£o para calcular a idade a partir da data de nascimento
function calculateAge(dateOfBirth) {
  if (!dateOfBirth) return 'N/A';
  const birthDate = new Date(dateOfBirth);
  const ageDifMs = Date.now() - birthDate.getTime();
  const ageDate = new Date(ageDifMs);
  return Math.abs(ageDate.getUTCFullYear() - 1970);
}

let isNotificationVisible = false;

async function handleLikeUser(likedUserId) {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        console.log('[ERROR] Usu√°rio n√£o autenticado.');
        alert('Voc√™ precisa estar logado para curtir um usu√°rio.');
        return;
    }

    const currentUserId = currentUser.uid;

    try {
        console.log(`[INFO] Tentando curtir usu√°rio com ID: ${likedUserId}`);

        // Obt√©m o documento do usu√°rio atual
        const currentUserDocRef = db.collection('users').doc(currentUserId);
        const currentUserDoc = await currentUserDocRef.get();

        if (!currentUserDoc.exists) {
            console.log('[ERROR] Documento do usu√°rio atual n√£o encontrado no Firestore.');
            return;
        }

        const currentUserData = currentUserDoc.data();

        console.log(`[INFO] Dados do usu√°rio atual:`, currentUserData);

        // Verifica se o usu√°rio √© VIP (mesma l√≥gica usada no loadUserProfile)
        const isVip = currentUserData.vip || false; // Usa a mesma verifica√ß√£o l√≥gica do loadUserProfile
        console.log(`[INFO] Status VIP do usu√°rio: ${isVip}`);

        // Para usu√°rios n√£o VIP, verifica o limite de curtidas
        if (!isVip) {
            const likesRemaining = currentUserData.likesRemaining || 15;
            console.log(`[INFO] Curtidas restantes para usu√°rio n√£o VIP: ${likesRemaining}`);

            if (likesRemaining <= 0) {
                console.log('[INFO] Limite de curtidas atingido. Exibindo modal.');
                showModalLimitLike();
                return;
            }

            // Diminui as curtidas restantes
            await currentUserDocRef.update({
                likesRemaining: firebase.firestore.FieldValue.increment(-1)
            });
            console.log('[INFO] Curtidas restantes decrementadas em 1.');
        }

        // Atualiza as curtidas do usu√°rio atual
        if (!currentUserData.MeusLikes) {
            console.log('[INFO] Adicionando primeira curtida para o usu√°rio atual.');
            await currentUserDocRef.set({ MeusLikes: [likedUserId] }, { merge: true });
        } else {
            console.log('[INFO] Atualizando lista de curtidas do usu√°rio atual.');
            await currentUserDocRef.update({
                MeusLikes: firebase.firestore.FieldValue.arrayUnion(likedUserId)
            });
        }

        // Exibir notifica√ß√£o √∫nica de curtida
        showSingleNotification('Voc√™ curtiu esse usu√°rio!');
        console.log(`[INFO] Curtida registrada com sucesso para o usu√°rio ${likedUserId}.`);

        // Atualiza as curtidas do usu√°rio curtido
        const likedUserDocRef = db.collection('users').doc(likedUserId);
        const likedUserDoc = await likedUserDocRef.get();

        if (!likedUserDoc.exists) {
            console.log('[ERROR] Documento do usu√°rio curtido n√£o encontrado no Firestore.');
            return;
        }

        const likedUserData = likedUserDoc.data();
        console.log(`[INFO] Dados do usu√°rio curtido:`, likedUserData);

        if (!likedUserData.MeusLikes) {
            console.log('[INFO] Adicionando primeira curtida para o usu√°rio curtido.');
            await likedUserDocRef.set({ MeusLikes: [currentUserId] }, { merge: true });
        } else {
            console.log('[INFO] Atualizando lista de curtidas do usu√°rio curtido.');
            await likedUserDocRef.update({
                MeusLikes: firebase.firestore.FieldValue.arrayUnion(currentUserId)
            });
        }

        const notification = {
            from: currentUserId,
            message: `Voc√™ acabou de receber uma curtida de ${currentUser.displayName || 'um usu√°rio'}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        };

        await likedUserDocRef.collection('notifications').add(notification);
        console.log('[INFO] Notifica√ß√£o enviada para o usu√°rio curtido.');

        // Verifica√ß√£o de match
        if (likedUserData.MeusLikes && likedUserData.MeusLikes.includes(currentUserId)) {
            console.log('[INFO] Match encontrado! Atualizando dados de ambos os usu√°rios.');

            const matchedUserName = currentUser.displayName || "um usu√°rio";

            await currentUserDocRef.update({
                Matches: firebase.firestore.FieldValue.arrayUnion(likedUserId),
                MeusLikes: firebase.firestore.FieldValue.arrayRemove(likedUserId)
            });

            await likedUserDocRef.update({
                Matches: firebase.firestore.FieldValue.arrayUnion(currentUserId),
                MeusLikes: firebase.firestore.FieldValue.arrayRemove(currentUserId)
            });

            document.getElementById('matchedUserName').innerText = likedUserData.name || "um usu√°rio";
            document.getElementById('matchNotificationCard').style.display = 'block';
            setTimeout(closeNotification, 10000); // Fecha ap√≥s 10 segundos

            await fetchUserMatches();
            await fetchLikedUsers();
        }
    } catch (error) {
        console.error('[ERROR] Erro ao curtir o usu√°rio:', error);
        alert('Erro ao curtir o usu√°rio, tente novamente.');
    }
}


function listenForMatchNotification(userId) {
    const userDocRef = db.collection('users').doc(userId);

    userDocRef.onSnapshot((doc) => {
        const data = doc.data();
        if (data.matchNotification) {
            const matchedUserName = data.matchNotification.matchedWith;

            // Exibir o card de notifica√ß√£o para o usu√°rio que recebeu o match
            document.getElementById('matchedUserName').innerText = matchedUserName;
            document.getElementById('matchNotificationCard').style.display = 'block';

            // Limpa a notifica√ß√£o de match ap√≥s exibir
            userDocRef.update({
                matchNotification: firebase.firestore.FieldValue.delete()
            });
        }
    });
}

// Inicie o listener para o usu√°rio atual ap√≥s o login
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        listenForMatchNotification(user.uid);
    }
});

function showSingleNotification(message) {
    const notificationElement = document.createElement('div');
    notificationElement.id = 'likeNotification';
    notificationElement.innerText = message;
    notificationElement.style.position = 'fixed';
    notificationElement.style.bottom = '20px';
    notificationElement.style.left = '50%';
    notificationElement.style.transform = 'translateX(-50%)';
    notificationElement.style.backgroundColor = '#333';
    notificationElement.style.color = '#fff';
    notificationElement.style.padding = '10px 20px';
    notificationElement.style.borderRadius = '5px';
    notificationElement.style.zIndex = '1000';
    notificationElement.style.border = '2px solid gold'; // Borda dourada
    document.body.appendChild(notificationElement);

    // Remove a notifica√ß√£o ap√≥s 3 segundos
    setTimeout(() => {
        notificationElement.remove();
    }, 5000);
}





// Fun√ß√£o para fechar o card de notifica√ß√£o
function closeNotification() {
    document.getElementById('matchNotificationCard').style.display = 'none';
}


async function fetchReceivedLikes() {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado.');
        return;
    }

    const currentUserId = currentUser.uid;
    const notificationsContainer = document.getElementById('notificationsContainer');
    const notificationCount = document.getElementById('notificationCount');

    // Limpa as notifica√ß√µes anteriores
    notificationsContainer.innerHTML = '';

    try {
        // Escuta as notifica√ß√µes do usu√°rio atual
        db.collection('users').doc(currentUserId).collection('notifications')
            .orderBy('timestamp', 'desc') // Ordena as notifica√ß√µes pela data
            .onSnapshot((notificationsSnapshot) => {
                notificationsContainer.innerHTML = ''; // Limpa as notifica√ß√µes anteriores
                let count = 0; // Contador de notifica√ß√µes

                notificationsSnapshot.forEach((doc) => {
                    const notificationData = doc.data();
                    count++; // Incrementa o contador para cada notifica√ß√£o recebida
                    const notificationElement = document.createElement('div');
                    notificationElement.classList.add('notification');
                    notificationElement.innerText = notificationData.message; // Exibe a mensagem da notifica√ß√£o
                    notificationsContainer.appendChild(notificationElement);
                });

                // Atualiza o contador de notifica√ß√µes
                notificationCount.innerText = count;
                notificationCount.style.display = count > 0 ? 'block' : 'none';

                if (count === 0) {
                    notificationsContainer.innerHTML = '<p>Sem curtidas recebidas.</p>'; // Mensagem caso n√£o haja notifica√ß√µes
                }
            });

    } catch (error) {
        console.error('Erro ao buscar curtidas recebidas:', error);
    }
}




function createUserCard(userData) {
    const card = document.createElement('div');
    card.className = 'user-card'; // Classe para estiliza√ß√£o do card

    // Adicione o conte√∫do do card, como o nome e foto do usu√°rio
    const userName = document.createElement('h3');
    userName.textContent = userData.name; // Nome do usu√°rio
    
    const userPhoto = document.createElement('img');
    userPhoto.src = userData.profilePhotoURL; // URL da foto de perfil
    userPhoto.alt = `${userData.name}'s profile picture`;
    userPhoto.className = 'user-photo'; // Classe para estiliza√ß√£o da foto

    // Adicionar informa√ß√µes do usu√°rio
    const userInfo = document.createElement('p');
    userInfo.className = 'user-info'; // Classe para estiliza√ß√£o das informa√ß√µes
    userInfo.innerHTML = `
        <strong>VIP:</strong> ${userData.vip ? 'Sim' : 'N√£o'}<br>
        <strong>Tipo de Usu√°rio:</strong> ${userData.tipouser}<br>
        <strong>Cidade:</strong> ${userData.cidade}<br>
        <strong>Renda:</strong> ${userData.income}<br>
    `;

    // Criar bot√£o de curtir
    const likeButton = document.createElement('button');
    likeButton.textContent = 'Curtir';
    likeButton.className = 'like-button'; // Classe para estiliza√ß√£o do bot√£o
    likeButton.onclick = () => handleLikeUser(userData.userId); // Chama a fun√ß√£o de curtir passando o ID do usu√°rio

    // Adiciona os elementos ao card
    card.appendChild(userPhoto);
    card.appendChild(userName);
    card.appendChild(userInfo); // Adiciona as informa√ß√µes do usu√°rio
    card.appendChild(likeButton);
    
    return card;
}




// Adiciona um evento de clique aos avatares para selecionar o g√™nero
document.querySelectorAll('.avatar').forEach(function(avatar) {
  avatar.addEventListener('click', function() {
    document.querySelectorAll('.avatar').forEach(function(otherAvatar) {
      otherAvatar.classList.remove('selected');
    });
    avatar.classList.add('selected');
  });
});


  
  
  

let currentAlbumId = null;

async function createAlbum() {
    const albumName = prompt("Digite o nome do √°lbum:");
    const isPrivate = confirm("Deseja tornar este √°lbum privado?");
    let accessCost = 0;

    if (isPrivate) {
        accessCost = parseInt(prompt("Digite o custo em pontos (PTS) para acessar este √°lbum:"), 10);
    }

    if (albumName) {
        const user = firebase.auth().currentUser;
        if (user) {
            try {
                const albumRef = await db.collection('users').doc(user.uid).collection('MeusAlbums').add({
                    albumName: albumName,
                    isPrivate: isPrivate,
                    accessCost: isPrivate ? accessCost : 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    allowedUsers: [] // Lista para armazenar IDs dos usu√°rios que t√™m acesso
                });
                currentAlbumId = albumRef.id;
                console.log(`√Ålbum criado com ID: ${albumRef.id}`);
                loadAlbums();
            } catch (error) {
                console.error('Erro ao criar o √°lbum:', error);
            }
        }
    }
}



function openModal() {
    const modal = document.getElementById('createAlbumModal');
    if (modal) {
        modal.classList.add('show'); // Adiciona a classe 'show' para exibir a modal
    }
}


function closeModal() {
    const modal = document.getElementById('createAlbumModal');
    if (modal) {
        modal.classList.remove('show'); // Remove a classe 'show' para esconder a modal
    }
}






function toggleCostField() {
    const costField = document.getElementById("costField");
    costField.style.display = document.getElementById("isPrivateCheckbox").checked ? "block" : "none";
}
async function submitAlbumForm() {
    const albumName = document.getElementById("albumNameInput").value;
    const isPrivate = document.getElementById("isPrivateCheckbox").checked;
    const accessCost = isPrivate ? parseInt(document.getElementById("accessCostInput").value, 10) : 0;

    if (!albumName) {
        alert("Por favor, insira o nome do √°lbum.");
        return;
    }

    // Chama a fun√ß√£o de cria√ß√£o do √°lbum, passando os dados da modal
    await createAlbumWithDetails(albumName, isPrivate, accessCost);

}
async function createAlbumWithDetails(albumName, isPrivate, accessCost) {
    const user = firebase.auth().currentUser;
    if (user) {
        try {
            // Cria o √°lbum no Firebase com o ownerId
            const albumRef = await db.collection('users').doc(user.uid).collection('MeusAlbums').add({
                albumName: albumName,
                isPrivate: isPrivate,
                accessCost: isPrivate ? accessCost : 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                allowedUsers: [],
                ownerId: user.uid // Dono do √°lbum
            });

            console.log(`√Ålbum criado com ID: ${albumRef.id}`);
            loadAlbums(); // Recarrega a galeria de √°lbuns

            // Fecha a modal ap√≥s criar o √°lbum
            closeModal(); // Fecha a janela de cria√ß√£o do √°lbum
        } catch (error) {
            console.error('Erro ao criar o √°lbum:', error);
        }
    }
}


function scrollToSection5() {
    const section5 = document.getElementById('section5');
    if (section5) {
        section5.scrollIntoView({ behavior: 'smooth' }); // Rola suavemente at√© a se√ß√£o
    }
}

function showSection5() {
    const section5 = document.getElementById('section5');
    const allSections = document.querySelectorAll('.section'); // Selecione todas as se√ß√µes

    // Esconde todas as se√ß√µes
    allSections.forEach(section => {
        section.style.display = 'none';
    });

    // Exibe a section5
    if (section5) {
        section5.style.display = 'block';
    }
}






async function loadAlbumContent(albumId, albumName) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    try {
        const albumRef = db.collection('users').doc(user.uid).collection('MeusAlbums').doc(albumId);
        const albumDoc = await albumRef.get();

        if (!albumDoc.exists) {
            console.error("√Ålbum n√£o encontrado ou n√£o pertence ao usu√°rio atual!");
            return;
        }

        const albumData = albumDoc.data();
        currentAlbumId = albumId;
        document.getElementById('albumName').textContent = albumName;
        document.getElementById('albumContent').style.display = 'block';
        document.getElementById('albumGallery').style.display = 'none';
        document.getElementById('addImagesButton').style.display = 'block';

        loadImagesForAlbum(albumId);
    } catch (error) {
        console.error('Erro ao carregar conte√∫do do √°lbum:', error);
    }
}


async function checkAccessPermission(userId, albumId, accessCost) {
    const userRef = db.collection('users').doc(userId);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
        alert('Erro: Usu√°rio n√£o encontrado!');
        return false;
    }

    const userData = userDoc.data();
    const userPoints = userData.points || 0;

    // Verifica se o usu√°rio tem pontos suficientes
    if (userPoints >= accessCost) {
        // Debita os pontos do usu√°rio
        await userRef.update({
            points: userPoints - accessCost
        });

        // Concede acesso ao √°lbum (adiciona o usu√°rio na lista de acessos)
        const albumRef = db.collection('users').doc(userId).collection('MeusAlbums').doc(albumId);
        await albumRef.update({
            allowedUsers: firebase.firestore.FieldValue.arrayUnion(userId) // Adiciona o usu√°rio √† lista de usu√°rios permitidos
        });

        return true; // Acesso concedido
    } else {
        return false; // Pontos insuficientes
    }
}



function openModalConfirmation(albumId, accessCost) {
    // Atualiza o texto com a quantidade de pontos
    const pointsText = document.getElementById('confirmationPoints');
    pointsText.innerText = `${accessCost} pontos`;

    // Salva as vari√°veis necess√°rias no objeto de confirma√ß√£o
    window.confirmationData = { albumId, accessCost };

    // Exibe o modal
    const modal = document.getElementById('modalConfirmation');
    modal.style.display = 'block'; // Torna o modal vis√≠vel
}


document.getElementById("confirm-access-btn").onclick = confirmAccess;
document.getElementById("cancel-access-btn").onclick = closeModalConfirmation;

async function confirmAccess() {
    const { albumId, accessCost } = window.confirmationData;
    const currentUserId = firebase.auth().currentUser.uid;

    const userRef = db.collection('users').doc(currentUserId);

    try {
        // Recuperar os pontos do usu√°rio
        const userDoc = await userRef.get();
        const userData = userDoc.data();
        const userPoints = userData?.points || 0;

        console.log('Pontos do usu√°rio:', userPoints);
        console.log('Custo de acesso:', accessCost);

        if (userPoints >= accessCost) {
            // Debitar pontos
            await userRef.update({ points: firebase.firestore.FieldValue.increment(-accessCost) });

            console.log(`Pontos debitados. Novo saldo: ${userPoints - accessCost}`);
            showSuccessMessage("Acesso concedido ao √°lbum!");

            // Abrir o √°lbum
            openAlbum(albumId, albumName);
        } else {
            showErrorMessage("Pontos insuficientes para acessar este √°lbum.");
            console.log('Usu√°rio n√£o tem pontos suficientes:', userPoints, '<', accessCost);
        }
    } catch (error) {
        console.error('Erro ao verificar pontos ou acessar o √°lbum:', error);
        showErrorMessage("Erro ao verificar pontos. Tente novamente mais tarde.");
    }

    // Fechar o modal de confirma√ß√£o
    closeModalConfirmation();
}


function closeModalConfirmation() {
    const modal = document.getElementById("confirmationModal");
    modal.style.display = "none"; // Fecha o modal
}



// Fun√ß√£o para exibir a mensagem de sucesso
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.classList.add('alert', 'success');
    alertDiv.innerHTML = `<strong>Sucesso!</strong> ${message}`;
    document.body.appendChild(alertDiv);
    
    // Mostra a mensagem com anima√ß√£o
    setTimeout(() => {
        alertDiv.classList.add('show');
    }, 100);

    // Remove a mensagem ap√≥s 5 segundos
    setTimeout(() => {
        alertDiv.classList.remove('show');
        alertDiv.remove();
    }, 5000);
}

function showErrorMessage(message) {
    const errorMessageDiv = document.getElementById("errorMessage");
    errorMessageDiv.textContent = message;

    // Exibe a mensagem
    errorMessageDiv.style.display = "block";

    // Esconde a mensagem ap√≥s 5 segundos
    setTimeout(() => {
        errorMessageDiv.style.display = "none";
    }, 5000); // A mensagem desaparece ap√≥s 5 segundos
}

function showCongratulationsModal() {
    const congratulationsModal = document.getElementById("congratulationsModal");
    congratulationsModal.style.display = "flex"; // Exibe o modal de parabeniza√ß√£o
}


// Fun√ß√£o para fechar o modal de parabeniza√ß√£o
function closeCongratulationsModal() {
    const modal = document.getElementById('congratulationsModal');
    modal.style.display = 'none';
}



async function initializeUserPoints(userId) {
    const userRef = db.collection('users').doc(userId);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
        await userRef.set({ points: 100 }); // Inicializa com 100 pontos, por exemplo
    }
}



async function deleteAlbum(albumId) {
    const user = firebase.auth().currentUser;
    if (user) {
        try {
            // Refer√™ncia ao documento do √°lbum dentro da cole√ß√£o 'MeusAlbums'
            const albumRef = db.collection('users')
                .doc(user.uid)
                .collection('MeusAlbums')
                .doc(albumId); // Usando o albumId para identificar o √°lbum
            
            // Deleta o √°lbum
            await albumRef.delete();
            console.log(`√Ålbum exclu√≠do com sucesso: ${albumId}`);

            // Recarregar os √°lbuns ap√≥s a exclus√£o
            loadAlbums();

            // Atualizar a section5 ap√≥s a exclus√£o do √°lbum
            updateSection5();  // Chama a fun√ß√£o para atualizar section5

        } catch (error) {
            console.error('Erro ao excluir o √°lbum:', error);
        }
    }
}

// Fun√ß√£o para atualizar a section5 com os √°lbuns atualizados
async function updateSection5() {
    const section5 = document.getElementById('section5');
    if (!section5) {
        console.error('Elemento section5 n√£o encontrado!');
        return; // Se a section5 n√£o for encontrada, interrompe a execu√ß√£o
    }

    section5.innerHTML = '';  // Limpa a section5 antes de adicionar o conte√∫do atualizado

    // Recarrega os √°lbuns na section5 (ou qualquer outro conte√∫do relevante)
    const user = firebase.auth().currentUser;
    if (user) {
        try {
            const albumsSnapshot = await db.collection('users').doc(user.uid).collection('MeusAlbums').get();
            albumsSnapshot.forEach(doc => {
                const albumData = doc.data();
                const albumName = albumData.albumName;

                const albumDiv = document.createElement('div');
                albumDiv.classList.add('album-thumbnail');
                albumDiv.textContent = albumName;

                // Adiciona o √°lbum √† section5
                section5.appendChild(albumDiv);
            });
        } catch (error) {
            console.error('Erro ao atualizar section5:', error);
        }
    }
}

// Fun√ß√£o para remover o √°lbum da galeria (UI)
function removeAlbumFromGallery(albumId) {
    const albumElement = document.getElementById(albumId);
    if (albumElement) {
        albumElement.remove();  // Remove o √°lbum da galeria visual
        console.log(`√Ålbum com ID: ${albumId} removido da galeria.`);
    } else {
        console.error(`√Ålbum com ID: ${albumId} n√£o encontrado na galeria.`);
    }
}

// Fun√ß√£o para voltar aos √°lbuns
function goBackToAlbums() {
    document.getElementById('albumContent').style.display = 'none';  // Ocultar o conte√∫do do √°lbum
    document.getElementById('albumGallery').style.display = 'flex';  // Mostrar a galeria de √°lbuns
}

// Chame `loadAlbums` ao inicializar a p√°gina para carregar a galeria de √°lbuns
document.addEventListener("DOMContentLoaded", () => {
    loadAlbums(); // Carregar os √°lbuns assim que a p√°gina for carregada
});



async function loadAlbums() {
    const albumGallery = document.getElementById('albumGallery');

    if (!albumGallery) {
        console.error('Elemento albumGallery n√£o encontrado!');
        return;
    }

    albumGallery.innerHTML = ''; // Limpa antes de adicionar os novos √°lbuns

    const user = firebase.auth().currentUser;

    if (user) {
        try {
            const userAlbumsRef = db.collection('users').doc(user.uid).collection('MeusAlbums');
            const albumsSnapshot = await userAlbumsRef.get();

            console.log('√Ålbuns encontrados para usu√°rio atual:', albumsSnapshot.size);

            if (albumsSnapshot.empty) {
                albumGallery.innerHTML = '<p>Voc√™ ainda n√£o tem √°lbuns.</p>';
                return;
            }

            albumsSnapshot.forEach(async (doc) => {
                const albumData = doc.data();
                const albumId = doc.id;
                const albumName = albumData.albumName;

                const albumDiv = document.createElement('div');
                albumDiv.classList.add('album-thumbnail');

                const albumTitle = document.createElement('div');
                albumTitle.textContent = albumName;
                albumDiv.appendChild(albumTitle);

                // Busca a primeira imagem do √°lbum
                const imagesSnapshot = await userAlbumsRef
                    .doc(albumId)
                    .collection('Imagens')
                    .limit(1)
                    .get();

                if (!imagesSnapshot.empty) {
                    const firstImage = imagesSnapshot.docs[0].data().imageUrl;
                    const albumCover = document.createElement('img');
                    albumCover.src = firstImage;
                    albumCover.alt = `Capa do √°lbum ${albumName}`;
                    albumCover.classList.add('album-cover');
                    albumDiv.insertBefore(albumCover, albumTitle);
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.textContent = 'Sem imagens';
                    placeholder.classList.add('album-placeholder');
                    albumDiv.insertBefore(placeholder, albumTitle);
                }

                // Define o evento de clique para abrir o √°lbum
                albumDiv.onclick = () => {
                    console.log(`Clique detectado no √°lbum: ${albumName} (ID: ${albumId})`);
                    openAlbum(albumId, albumName);
                };

                albumGallery.appendChild(albumDiv);
            });
        } catch (error) {
            console.error('Erro ao carregar √°lbuns:', error);
            albumGallery.innerHTML = '<p>Erro ao carregar √°lbuns. Tente novamente mais tarde.</p>';
        }
    } else {
        console.log('Usu√°rio n√£o autenticado.');
        albumGallery.innerHTML = '<p>Por favor, fa√ßa login para ver seus √°lbuns.</p>';
    }
}


function closeAlbumModal() {
    const albumModal = document.getElementById('albumModal');
    albumModal.style.display = 'none'; // Esconde o modal
}




async function openAlbum(albumId, albumName) {
    const albumModal = document.getElementById('albumModal');
    const albumContent = albumModal.querySelector('.modal-body');
    albumContent.innerHTML = ''; // Limpa o conte√∫do do modal

    // Define o ID do √°lbum atual para uso nos bot√µes
    window.currentAlbumId = albumId; // Define uma vari√°vel global para o ID do √°lbum atual

    try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            alert("Voc√™ precisa estar logado para acessar os √°lbuns.");
            return;
        }

        // Refer√™ncia ao Firestore para o √°lbum atual
        const albumRef = db.collection('users').doc(currentUser.uid).collection('MeusAlbums').doc(albumId);
        const albumDoc = await albumRef.get();

        if (!albumDoc.exists) {
            alert("√Ålbum n√£o encontrado.");
            return;
        }

        const albumData = albumDoc.data();
        const accessCost = albumData.accessCost || 0; // Valor do √°lbum
        const allowedUsers = albumData.allowedUsers || []; // Usu√°rios com acesso

        // Exibir informa√ß√µes do √°lbum
        const albumInfo = document.createElement('div');
        albumInfo.classList.add('album-info');

        const valueInfo = document.createElement('p');
        valueInfo.textContent = `Valor do √Ålbum: ${accessCost} pontos`;
        albumInfo.appendChild(valueInfo);

        const usersInfo = document.createElement('p');
        usersInfo.textContent = `Usu√°rios com acesso: ${allowedUsers.length}`;
        albumInfo.appendChild(usersInfo);

        albumContent.appendChild(albumInfo);

        // Busca as imagens da subcole√ß√£o 'Imagens'
        const imagesSnapshot = await albumRef.collection('Imagens').get();

        if (imagesSnapshot.empty) {
            const noImagesMessage = document.createElement('p');
            noImagesMessage.textContent = `Nenhuma imagem encontrada no √°lbum "${albumName}".`;
            albumContent.appendChild(noImagesMessage);
        } else {
            imagesSnapshot.forEach((doc) => {
                const imageData = doc.data();

                // Verifica se a imagem tem a URL
                if (!imageData.imageUrl) {
                    console.error(`Imagem sem URL no documento: ${doc.id}`);
                    return;
                }

                // Cria o elemento de imagem
                const imgElement = document.createElement('img');
                imgElement.src = imageData.imageUrl;
                imgElement.alt = imageData.imageName || "Imagem sem nome";
                imgElement.classList.add('album-image');

                // Adiciona a imagem ao conte√∫do do modal
                albumContent.appendChild(imgElement);
            });
        }

        // Adiciona os bot√µes ao modal
        addAlbumButtons(albumContent);

        // Exibe o modal e define o t√≠tulo do √°lbum
        albumModal.querySelector('.modal-title').textContent = albumName || "√Ålbum Sem Nome";
        albumModal.style.display = 'block';
    } catch (error) {
        console.error("Erro ao carregar as informa√ß√µes do √°lbum:", error);
        const errorMessage = document.createElement('p');
        errorMessage.textContent = "Erro ao carregar as informa√ß√µes. Por favor, tente novamente.";
        albumContent.appendChild(errorMessage);
    }
}
function addAlbumButtons(albumContent) {
    // Cria ou seleciona o cont√™iner do rodap√©
    let footer = document.querySelector('.modal-footer');
    if (!footer) {
        footer = document.createElement('div');
        footer.classList.add('modal-footer');
        albumContent.parentElement.appendChild(footer);
    }

    footer.innerHTML = ''; // Limpa os bot√µes existentes

    // Bot√£o de Adicionar Imagem
    const addImagesButton = document.createElement('button');
    addImagesButton.textContent = "Adicionar Imagem ao √Ålbum";
    addImagesButton.classList.add('btn', 'btn-secondary');
    addImagesButton.onclick = () => addImagesToAlbum(window.currentAlbumId);
    footer.appendChild(addImagesButton);

    // Bot√£o para Alterar Valor do √Ålbum
    const changeValueButton = document.createElement('button');
    changeValueButton.textContent = "Alterar Valor do √Ålbum";
    changeValueButton.classList.add('btn', 'btn-warning');
    changeValueButton.onclick = () => showChangeValueInput(window.currentAlbumId);
    footer.appendChild(changeValueButton);

    // Bot√£o de Voltar aos √Ålbuns
    const backButton = document.createElement('button');
    backButton.textContent = "Voltar aos √Ålbuns";
    backButton.classList.add('btn', 'btn-secondary');
    backButton.onclick = goBackToAlbums;
    footer.appendChild(backButton);

    // Bot√£o de Excluir √Ålbum
    const deleteButton = document.createElement('button');
    deleteButton.textContent = "Excluir √Ålbum";
    deleteButton.classList.add('btn', 'btn-danger');
    deleteButton.onclick = () => deleteAlbum(window.currentAlbumId);
    footer.appendChild(deleteButton);
}

function showChangeValueInput(albumId) {
    const albumModal = document.getElementById('albumModal');
    const albumContent = albumModal.querySelector('.modal-body');

    // Limpa conte√∫do antigo e adiciona o input de altera√ß√£o de valor
    const valueForm = document.createElement('div');
    valueForm.classList.add('change-value-form');

    const inputLabel = document.createElement('label');
    inputLabel.textContent = "Novo Valor do √Ålbum (em pontos):";
    valueForm.appendChild(inputLabel);

    const valueInput = document.createElement('input');
    valueInput.type = 'number';
    valueInput.min = 0;
    valueInput.classList.add('form-control', 'mt-2');
    valueForm.appendChild(valueInput);

    const saveButton = document.createElement('button');
    saveButton.textContent = "Salvar";
    saveButton.classList.add('btn', 'btn-success', 'mt-2');
    saveButton.onclick = () => updateAlbumValue(albumId, valueInput.value);
    valueForm.appendChild(saveButton);

    albumContent.appendChild(valueForm);
}
async function updateAlbumValue(albumId, newValue) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        alert("Voc√™ precisa estar logado para alterar o valor do √°lbum.");
        return;
    }

    try {
        // Atualiza o valor do √°lbum no Firestore
        const albumRef = db.collection('users').doc(currentUser.uid).collection('MeusAlbums').doc(albumId);
        await albumRef.update({
            accessCost: parseInt(newValue, 10), // Salva o novo valor
        });

        alert("Valor do √°lbum atualizado com sucesso!");
    } catch (error) {
        console.error("Erro ao atualizar o valor do √°lbum:", error);
        alert("Erro ao atualizar o valor. Por favor, tente novamente.");
    }
}

async function addImagesToAlbum(albumId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;

    input.addEventListener('change', async (event) => {
        const files = event.target.files;

        for (let file of files) {
            const imageUrl = await uploadImageAndReturnUrl(file, firebase.auth().currentUser.uid);
            await db.collection('users')
                .doc(firebase.auth().currentUser.uid)
                .collection('MeusAlbums')
                .doc(albumId)
                .collection('Imagens')
                .add({
                    imageName: file.name,
                    imageUrl: imageUrl,
                });
        }

        alert("Imagens adicionadas com sucesso!");
        openAlbum(albumId, document.getElementById('albumName').textContent); // Recarrega o √°lbum
    });

    input.click();
}
function goBackToAlbums() {
    const albumModal = document.getElementById('albumModal');
    albumModal.style.display = 'none'; // Esconde o modal
}
async function deleteAlbum(albumId) {
    if (confirm("Voc√™ tem certeza que deseja excluir este √°lbum?")) {
        await db.collection('users')
            .doc(firebase.auth().currentUser.uid)
            .collection('MeusAlbums')
            .doc(albumId)
            .delete();

        alert("√Ålbum exclu√≠do com sucesso!");
        goBackToAlbums(); // Retorna √† lista de √°lbuns
    }
}


// Abre o modal para ampliar a imagem
function openImagePreview(imageUrl) {
    const imagePreviewModal = document.getElementById('imagePreviewModal');
    const previewImage = document.getElementById('previewImage');

    previewImage.src = imageUrl; // Define a imagem ampliada
    imagePreviewModal.style.display = 'block'; // Exibe o modal de imagem ampliada
}


// Fecha o modal de pr√©-visualiza√ß√£o
function closeImagePreview() {
    const imagePreviewModal = document.getElementById('imagePreviewModal');
    imagePreviewModal.style.display = 'none';
}



function showImageOptions(imageUrl, imageName, imageId) {
    console.log(`Mostrando op√ß√µes para a imagem: ${imageName}, Image ID: ${imageId}`);  // Log para verificar o imageId

    // Verifica se o menu j√° existe no DOM
    const existingMenu = document.querySelector('.options-menu');
    if (existingMenu) {
        console.log('Menu de op√ß√µes j√° existe. N√£o criando um novo.');
        return; // Se o menu j√° existir, n√£o faz nada
    }

    // Cria o menu de op√ß√µes
    const optionsMenu = document.createElement('div');
    optionsMenu.classList.add('options-menu');

    const enlargeOption = document.createElement('button');
    enlargeOption.textContent = 'Ampliar Foto';
    enlargeOption.onclick = () => {
        console.log(`Ampliando a imagem: ${imageName}`);
        enlargeImage(imageUrl);  // Chama a fun√ß√£o enlargeImage com a URL da imagem
        document.body.removeChild(optionsMenu); // Remove o menu de op√ß√µes
    };

    const deleteOption = document.createElement('button');
    deleteOption.textContent = 'Excluir Foto';
    deleteOption.onclick = () => {
        console.log(`Excluir foto clicado para: ${imageName}, Image ID: ${imageId}`);  // Log para verificar quando a exclus√£o √© acionada
        deleteImage(imageId); // Exclui a imagem
        document.body.removeChild(optionsMenu); // Remove o menu de op√ß√µes
    };

    optionsMenu.appendChild(enlargeOption);
    optionsMenu.appendChild(deleteOption);

    // Adiciona o menu de op√ß√µes √† tela
    document.body.appendChild(optionsMenu);

    // Estilos b√°sicos para o menu (opcional)
    optionsMenu.style.position = 'absolute';
    optionsMenu.style.top = `${event.clientY}px`; // Posiciona o menu onde o clique ocorreu
    optionsMenu.style.left = `${event.clientX}px`;
    optionsMenu.style.backgroundColor = '#fff';
    optionsMenu.style.border = '1px solid #ccc';
    optionsMenu.style.padding = '10px';
    optionsMenu.style.boxShadow = '0px 4px 8px rgba(0, 0, 0, 0.1)';
    optionsMenu.style.borderRadius = '8px';
}

function enlargeImage(imageUrl) {
    // Fun√ß√£o para ampliar a imagem
    const imageModal = document.createElement('div');
    imageModal.style.position = 'fixed';
    imageModal.style.top = '0';
    imageModal.style.left = '0';
    imageModal.style.width = '100%';
    imageModal.style.height = '100%';
    imageModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    imageModal.style.display = 'flex';
    imageModal.style.alignItems = 'center';
    imageModal.style.justifyContent = 'center';

    const img = document.createElement('img');
    img.src = imageUrl;
    img.style.maxWidth = '90%';
    img.style.maxHeight = '90%';

    imageModal.appendChild(img);
    document.body.appendChild(imageModal);

    // Fecha o modal ao clicar
    imageModal.onclick = () => {
        document.body.removeChild(imageModal);
    };
}
async function deleteImage(imageId) {
    const user = firebase.auth().currentUser;
    if (user) {
        try {
            // Acessar o √°lbum do usu√°rio
            const albumRef = db.collection('users')
                .doc(user.uid)
                .collection('MeusAlbums')
                .doc(currentAlbumId); // Acessar o √°lbum atual
            
            // Excluir a foto do √°lbum (remover campo da foto)
            await albumRef.update({
                fotos: firebase.firestore.FieldValue.arrayRemove(imageId) // Remove a foto usando seu ID
            });

            console.log(`Foto exclu√≠da com sucesso: ${imageId}`);

            // Recarregar as fotos do √°lbum ap√≥s exclus√£o
            loadAlbumPhotos(currentAlbumId);
        } catch (error) {
            console.error('Erro ao excluir a foto:', error);
        }
    }
}



async function loadAlbumPhotos(albumId) {
    const user = firebase.auth().currentUser;
    if (user) {
        try {
            const albumRef = db.collection('users')
                .doc(user.uid)
                .collection('MeusAlbums')
                .doc(albumId);
            const albumPhotosRef = albumRef.collection('Imagens');

            const photosSnapshot = await albumPhotosRef.get();
            const photos = photosSnapshot.docs.map(doc => doc.data());
            console.log(photos); // Log para visualizar as fotos
            // Aqui voc√™ pode atualizar a UI para exibir as fotos restantes
        } catch (error) {
            console.error('Erro ao carregar as fotos do √°lbum:', error);
        }
    }
}




function renderThumbnailInGallery(imageUrl, imageName, imageId) {
    console.log(`Renderizando imagem: ${imageName}, Image ID: ${imageId}`);  // Log para verificar o imageId
    const imageGallery = document.getElementById('imageGallery');
    const imageContainer = document.createElement('div');
    imageContainer.classList.add('image-container');

    // Criar a miniatura da imagem
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = imageName;
    img.classList.add('image-thumbnail');
    img.onclick = () => {
        console.log(`Clicou na imagem ${imageName}, com ID ${imageId}`);  // Log para verificar o clique
        showImageOptions(imageUrl, imageName, imageId);  // Passa o imageId
    };

    imageContainer.appendChild(img);
    imageGallery.appendChild(imageContainer);
}



function closeModal() {
    const modal = document.getElementById('createAlbumModal');
    if (modal) {
        modal.style.display = 'none'; // Fecha o modal escondendo a div
    }
}




async function addImagesToAlbum(albumId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;

    input.addEventListener('change', async (event) => {
        const selectedImages = event.target.files;
        const progressBar = document.getElementById('progressBar');

        if (progressBar) {
            progressBar.style.display = 'block';
        }

        const user = firebase.auth().currentUser;
        if (user) {
            for (let i = 0; i < selectedImages.length; i++) {
                const image = selectedImages[i];
                const imageUrl = await uploadImageAndReturnUrl(image, user.uid);
                const imageName = prompt('Digite o nome da imagem:');

                // Adiciona a imagem ao Firestore
                await db.collection('users').doc(user.uid).collection('MeusAlbums').doc(albumId).collection('Imagens').add({
                    imageUrl: imageUrl,
                    imageName: imageName
                });

                if (progressBar) {
                    const progressValue = ((i + 1) / selectedImages.length) * 100;
                    progressBar.value = progressValue;
                }
            }

            if (progressBar) {
                progressBar.style.display = 'none';
            }

            // Recarrega as imagens do √°lbum ap√≥s adicionar novas fotos
            openAlbum(albumId, document.getElementById('albumName').textContent);
        }
    });

    input.click();
}

// Fun√ß√£o para fechar o √°lbum e voltar √† galeria de √°lbuns
function closeAlbum() {
    document.getElementById('albumContent').style.display = 'none';
    document.getElementById('albumGallery').style.display = 'flex';
}

// Fun√ß√£o para exibir imagem ampliada no modal
function showImageModal(imageUrl, imageName) {
    const imagemModal = new bootstrap.Modal(document.getElementById('imagemModal'));
    document.getElementById('imagemAmpliada').src = imageUrl;
    document.getElementById('imagemAmpliadaNome').textContent = imageName;
    imagemModal.show();
}



// Fun√ß√£o para fazer o upload da imagem e retornar a URL
async function uploadImageAndReturnUrl(image, userId) {
    const storageRef = firebase.storage().ref();
    const imageRef = storageRef.child(`images/${userId}/${image.name}`);
    await imageRef.put(image);
    return await imageRef.getDownloadURL();
}

// Carrega a lista de √°lbuns ao iniciar a p√°gina
document.addEventListener('DOMContentLoaded', loadAlbums);



document.addEventListener('DOMContentLoaded', setupImageGallery);


// Fun√ß√£o para verificar match entre usu√°rios
async function verificarMatch(userId, likerUserId) {
    try {
        // Verifica se o documento do usu√°rio que curtiu existe
        const likerUserRef = db.collection('users').doc(likerUserId);
        const likerUserDoc = await likerUserRef.get();
        if (!likerUserDoc.exists) {
            throw new Error('Documento do usu√°rio que curtiu n√£o encontrado');
        }

        // Verifica se ocorre um match (se o usu√°rio do card est√° na lista meusFans do usu√°rio que curtiu)
        const meusFans = likerUserDoc.data().meusFans || [];
        if (meusFans.includes(userId)) {
            console.log(`Match encontrado entre ${userId} e ${likerUserId}!`);
            // Aqui voc√™ pode adicionar l√≥gica adicional para lidar com o match, como notifica√ß√µes, etc.
        }

    } catch (error) {
        console.error('Erro ao verificar match:', error);
    }
}

// Fun√ß√£o de exemplo para n√£o curtir um usu√°rio (substituir com l√≥gica real)
function handleDislike(userId) {
    console.log(`Usu√°rio com ID ${userId} n√£o curtido!`);
    // Aqui voc√™ pode implementar a l√≥gica para processar o "n√£o curtir"
}

// Chama a fun√ß√£o para renderizar os usu√°rios quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', renderUsers);


  // Fun√ß√£o para exibir a timeline na Se√ß√£o 2
  function showTimeline() {
    const timelineSection = document.getElementById('timelineSection');
    timelineSection.style.display = 'block';

    // Implemente aqui a l√≥gica para carregar postagens existentes, se necess√°rio
  }

// Fun√ß√£o para iniciar o listener de mensagens
function startMessageListener(currentUserId) {
    // Obter refer√™ncia para a cole√ß√£o de conversas do usu√°rio
    const conversasRef = db.collection('conversas').where('participants', 'array-contains', currentUserId);

    conversasRef.onSnapshot(snapshot => {
        snapshot.forEach(async conversaDoc => {
            const conversaId = conversaDoc.id;
            const mensagensRef = conversaDoc.ref.collection('mensagens')
                .orderBy('timestamp', 'desc')
                .limit(1);

            mensagensRef.onSnapshot(mensagemSnapshot => {
                mensagemSnapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const mensagem = change.doc.data();
                        
                        // Verifica se a mensagem √© para o usu√°rio atual e n√£o foi enviada por ele mesmo
                        if (mensagem.destinatarioId === currentUserId && mensagem.remetenteId !== currentUserId) {
                            exibirNotificacao(mensagem.remetenteNome, mensagem.texto);
                        }
                    }
                });
            });
        });
    });
}

// Fun√ß√£o para exibir notifica√ß√£o
function exibirNotificacao(remetenteNome, textoMensagem) {
    if (!("Notification" in window)) {
        console.log("Esse navegador n√£o suporta notifica√ß√µes.");
        return;
    }

    // Pede permiss√£o ao usu√°rio para exibir notifica√ß√µes
    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            new Notification(`Nova mensagem de ${remetenteNome}`, {
                body: textoMensagem,
                icon: 'chat-icon.png' // Caminho para o √≠cone da notifica√ß√£o
            });
        } else {
            console.log("Permiss√£o para notifica√ß√µes negada.");
        }
    });
}





// Fun√ß√£o para remover a amizade
async function removerAmizade(currentUserId, friendId) {
  try {
    // Remova a amizade da lista do usu√°rio atual
    const userRef = db.collection('users').doc(currentUserId);
    await userRef.update({
      meusAmigos: firebase.firestore.FieldValue.arrayRemove(friendId)
    });

    // Remova a amizade da lista do amigo
    const friendRef = db.collection('users').doc(friendId);
    const friendDoc = await friendRef.get();
    if (friendDoc.exists) {
      const friendData = friendDoc.data();
      const updatedFriends = friendData.meusAmigos.filter(id => id !== currentUserId);
      await friendRef.update({
        meusAmigos: updatedFriends
      });
    }

    // Recarregue a lista de amigos ap√≥s a remo√ß√£o
    loadFriendsList(currentUserId);

    console.log('Amizade removida com sucesso.');
  } catch (error) {
    console.error('Erro ao remover amizade:', error);
    alert('Erro ao remover amizade.');
  }
}


// Fun√ß√£o para aceitar uma solicita√ß√£o de amizade
async function acceptRequest(currentUserId, requestId) {
  try {
    // Adiciona o amigo √† lista de amigos
    await db.collection('users').doc(currentUserId).update({
      meusAmigos: firebase.firestore.FieldValue.arrayUnion(requestId),
      solicitacoesRecebidas: firebase.firestore.FieldValue.arrayRemove(requestId)
    });

    await db.collection('users').doc(requestId).update({
      meusAmigos: firebase.firestore.FieldValue.arrayUnion(currentUserId),
      solicitacoesEnviadas: firebase.firestore.FieldValue.arrayRemove(currentUserId)
    });

    loadReceivedRequests(currentUserId);
    loadFriendsList(currentUserId);
  } catch (error) {
    console.error('Erro ao aceitar solicita√ß√£o:', error);
    alert('Erro ao aceitar solicita√ß√£o. Tente novamente mais tarde.');
  }
}

// Fun√ß√£o para rejeitar uma solicita√ß√£o de amizade
async function rejectRequest(currentUserId, requestId) {
  try {
    // Remove a solicita√ß√£o recebida
    await db.collection('users').doc(currentUserId).update({
      solicitacoesRecebidas: firebase.firestore.FieldValue.arrayRemove(requestId)
    });

    await db.collection('users').doc(requestId).update({
      solicitacoesEnviadas: firebase.firestore.FieldValue.arrayRemove(currentUserId)
    });

    loadReceivedRequests(currentUserId);
  } catch (error) {
    console.error('Erro ao rejeitar solicita√ß√£o:', error);
    alert('Erro ao rejeitar solicita√ß√£o. Tente novamente mais tarde.');
  }
}

// Listener para mudan√ßas no estado de autentica√ß√£o
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    // Carregar as solicita√ß√µes recebidas e a lista de amigos quando o usu√°rio estiver autenticado
    loadReceivedRequests(user.uid);
    loadFriendsList(user.uid);
  } else {
    // Lidar com o caso em que o usu√°rio n√£o est√° autenticado
    document.getElementById('receivedRequestsContainer').innerHTML = 'Voc√™ precisa estar autenticado para ver suas solicita√ß√µes recebidas.';
    document.getElementById('friendsListContainer').innerHTML = 'Voc√™ precisa estar autenticado para ver seus amigos.';
  }
});


let isPosting = false;


// Fun√ß√£o para postar uma not√≠cia
function postarNoticia() {
  if (isPosting) {
    return; // Prevenir m√∫ltiplas execu√ß√µes simult√¢neas
  }
  isPosting = true; // Definir a flag

  // Mostra o preloader
  document.getElementById('preloader').style.display = 'block';

  const postImageFile = document.getElementById('postImage').files[0];
  const postText = document.getElementById('postText').value;

  // Verifica se h√° imagem selecionada e texto
  if (!postImageFile || !postText) {
    alert('Por favor, escolha uma imagem e escreva algo antes de postar.');
    console.log('Imagem ou texto ausente');
    isPosting = false;
    // Esconde o preloader em caso de erro
    document.getElementById('preloader').style.display = 'none';
    return;
  }

  // Refer√™ncia ao usu√°rio autenticado
  const user = firebase.auth().currentUser;

  // Verifica se o usu√°rio est√° autenticado
  if (!user) {
    alert('Usu√°rio n√£o autenticado. Fa√ßa login para postar.');
    console.log('Usu√°rio n√£o autenticado');
    isPosting = false;
    // Esconde o preloader em caso de erro
    document.getElementById('preloader').style.display = 'none';
    return;
  }

  const userId = user.uid; // ID √∫nico do usu√°rio

  // Buscar o nome correto do autor no documento do usu√°rio
  db.collection('users').doc(userId).get().then((doc) => {
    if (doc.exists) {
      const userName = doc.data().name || "Usu√°rio An√¥nimo"; // Nome do usu√°rio

      console.log(`Usu√°rio autenticado: ${userId} - ${userName}`);

      // Refer√™ncia para o Firebase Storage
      const storageRef = firebase.storage().ref();
      const postImagesRef = storageRef.child('postImages/' + userId + '/' + postImageFile.name);

      console.log('Iniciando upload da imagem');

      // Upload da imagem para o Firebase Storage
      postImagesRef.put(postImageFile)
        .then((snapshot) => {
          console.log('Imagem enviada para o Firebase Storage');
          // Obter a URL da imagem ap√≥s o upload
          return snapshot.ref.getDownloadURL();
        })
        .then((downloadURL) => {
          console.log('URL da imagem obtida:', downloadURL);

          // Timestamp atual
          const timestamp = firebase.firestore.FieldValue.serverTimestamp();

          // Objeto de dados da postagem com autorId, URL da imagem e outros dados
          const postData = {
            texto: postText,
            autorId: userId,
            autorNome: userName,
            postImageUrl: downloadURL,
            timestamp: timestamp
          };

          // Refer√™ncia para a cole√ß√£o timelineLux
          const timelineLuxRef = db.collection('timelineLux');

          console.log('Adicionando postagem na cole√ß√£o timelineLux');

          // Adiciona na cole√ß√£o timelineLux
          return timelineLuxRef.add(postData)
            .then((docRef) => {
              console.log('Postagem salva na cole√ß√£o timelineLux com ID:', docRef.id);

              // Atualiza postData com o ID da postagem
              const updatedPostData = {
                ...postData,
                postId: docRef.id
              };

              console.log('Atualizando documento com postId');

              // Atualiza o documento com o postId
              return docRef.update({ postId: docRef.id })
                .then(() => {
                  console.log('Documento atualizado com postId:', docRef.id);

                  // Refer√™ncia para a subcole√ß√£o MinhaTimeline do usu√°rio
                  const userTimelineRef = db.collection('users').doc(userId).collection('MinhaTimeline');

                  console.log('Adicionando postagem na subcole√ß√£o MinhaTimeline');

                  // Adiciona na subcole√ß√£o MinhaTimeline
                  return userTimelineRef.doc(docRef.id).set(updatedPostData)
                    .then(() => {
                      console.log('Postagem tamb√©m salva na subcole√ß√£o MinhaTimeline do usu√°rio.');
                      limparCampos(); // Fun√ß√£o para limpar campos ap√≥s postagem
                      isPosting = false; // Resetar a flag
                      // Esconde o preloader ap√≥s a postagem ser conclu√≠da
                      document.getElementById('preloader').style.display = 'none';
                      
                      // Atualiza as postagens para exibir a nova postagem
                      exibirPostagens();
                    });
                });
            });
        })
        .catch((error) => {
          console.error('Erro ao salvar postagem:', error);
          isPosting = false; // Resetar a flag em caso de erro
          // Esconde o preloader em caso de erro
          document.getElementById('preloader').style.display = 'none';
        });
    } else {
      console.log('Documento de usu√°rio n√£o encontrado.');
      isPosting = false; // Resetar a flag se o documento n√£o for encontrado
      // Esconde o preloader em caso de erro
      document.getElementById('preloader').style.display = 'none';
    }
  }).catch((error) => {
    console.error('Erro ao buscar documento do usu√°rio:', error);
    isPosting = false; // Resetar a flag em caso de erro
    // Esconde o preloader em caso de erro
    document.getElementById('preloader').style.display = 'none';
  });
}

// Fun√ß√£o para carregar e exibir postagens da timelineLux
function exibirPostagens() {
  const timelinePostsDiv = document.getElementById('timelinePosts');
  timelinePostsDiv.innerHTML = ''; // Limpa conte√∫do atual para evitar duplicatas

  // Refer√™ncia para a cole√ß√£o timelineLux
  const timelineLuxRef = db.collection('timelineLux');

  // Consulta todas as postagens ordenadas por timestamp (mais recente primeiro)
  timelineLuxRef.orderBy('timestamp', 'desc').get()
    .then((querySnapshot) => {
      querySnapshot.forEach(async (doc) => {
        const postData = doc.data();
        postData.id = doc.id; // Adiciona o ID do documento aos dados da postagem

        const postElement = await criarElementoPost(postData);
        timelinePostsDiv.appendChild(postElement);
      });
    })
    .catch((error) => {
      console.error('Erro ao buscar postagens:', error);
    });
}

// Chamada para exibir postagens ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
  exibirPostagens();
});

// Certifique-se de que a fun√ß√£o `postarNoticia` seja chamada apenas uma vez ao clicar no bot√£o de postagem
document.getElementById('postButton').addEventListener('click', postarNoticia);


// Fun√ß√£o para limpar os campos ap√≥s a postagem
function limparCampos() {
  document.getElementById('postImage').value = '';
  document.getElementById('postText').value = '';
  console.log('Campos de entrada limpos');
}


  // Carregar perfil do usu√°rio ao carregar a p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    // Substitua 'user-id' pelo ID real do usu√°rio ou utilize l√≥gica para obter dinamicamente
    const userId = 'user-id';
    loadUserProfile(userId);
  });

  // Carregar perfil do usu√°rio baseado no ID na URL
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');

    if (userId) {
      // Carregar perfil do usu√°rio com base no userId
      loadUserProfile(userId);
    } else {
      console.error('ID do usu√°rio n√£o encontrado na URL.');
    }
  });

function loadUserProfile(userId) {
    const userDoc = db.collection('users').doc(userId);

    userDoc.get().then((doc) => {
        if (doc.exists) {
            const userData = doc.data();

            // Carregar a foto e o nome do usu√°rio
            const userAvatar = userData.profilePhotoURL || '';
            const userName = userData.name || '';
            const isVip = userData.vip || false; // Verifica o status VIP
            const userPoints = userData.points || 0; // Carrega os pontos do usu√°rio

            // Atualizar os elementos do perfil
            document.getElementById('profileAvatar').src = userAvatar;
            document.getElementById('profileName').textContent = userName;

            // Exibir o status VIP ou Basic
            const statusBar = document.getElementById('statusBar');
            if (isVip) {
                statusBar.innerHTML = `Status: VIP | Pontos: ${userPoints}`;
                statusBar.style.backgroundColor = '#28a745'; // Verde para VIP
            } else {
                statusBar.innerHTML = `Status: Basic | Pontos: ${userPoints}`;
                statusBar.style.backgroundColor = '#dc3545'; // Vermelho para Basic
            }
            statusBar.style.color = 'white';
        } else {
            console.log('Documento n√£o encontrado.');
        }
    }).catch((error) => {
        console.error('Erro ao obter documento:', error);
    });
}


  // Fun√ß√£o para rolar at√© uma se√ß√£o espec√≠fica
  function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
      section.scrollIntoView({ behavior: 'smooth' });

      // Atualizar estado dos bot√µes da barra de navega√ß√£o
      const buttons = document.querySelectorAll('.navbar-button');
      buttons.forEach(button => button.classList.remove('glow-active'));

      const activeButton = document.getElementById('btn' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
      if (activeButton) {
        activeButton.classList.add('glow-active');
      }
    }
  }

  // Fun√ß√£o para exibir a timeline de postagens
  async function showTimeline() {
    const timelinePosts = document.getElementById('timelinePosts');
    timelinePosts.innerHTML = ""; // Limpa conte√∫do anterior

    try {
      // Obter usu√°rio atualmente autenticado
      const user = firebase.auth().currentUser;
      if (!user) {
        throw new Error('Usu√°rio n√£o autenticado.');
      }

      const userId = user.uid; // ID √∫nico do usu√°rio

      // Consultar postagens na cole√ß√£o do usu√°rio
      const userPostsRef = db.collection('users').doc(userId).collection('posts');
      const snapshot = await userPostsRef.orderBy('timestamp', 'desc').get();

      // Processar resultados das postagens
      snapshot.forEach(doc => {
        const postData = doc.data();
        const postElement = createPostElement(postData);
        timelinePosts.appendChild(postElement);
      });

    } catch (error) {
      console.error('Erro ao carregar timeline:', error);
    }
  }









// Fun√ß√£o para formatar data
function formatDate(timestamp) {
  if (timestamp && typeof timestamp === 'object' && timestamp.toDate) {
    // Para timestamps do Firestore
    timestamp = timestamp.toDate();
  }

  const date = new Date(timestamp);
  const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
  return date.toLocaleDateString('pt-BR', options);
}



// Fun√ß√£o para incrementar curtidas no Firestore e atualizar bot√£o de "Gostei"
async function handleLike(postData) {
  const postRef = db.collection('timelineLux').doc(postData.id);

  try {
    await db.runTransaction(async (transaction) => {
      const postDoc = await transaction.get(postRef);
      if (!postDoc.exists) {
        throw new Error("Documento n√£o existe!");
      }

      // Incrementa o campo Curtidas
      const newLikes = (postDoc.data().Curtidas || 0) + 1;
      transaction.update(postRef, { Curtidas: newLikes });

      // Atualiza a classe do bot√£o de "Gostei"
      const likeButton = document.getElementById(`likeButton_${postData.id}`);
      if (likeButton) {
        likeButton.classList.add('liked'); // Adiciona classe para indicar que foi curtido
      }

    });

    // Atualiza a interface do usu√°rio
    const likesCountElement = document.getElementById(`likesCount_${postData.id}`);
    if (likesCountElement) {
      likesCountElement.textContent = (postData.Curtidas || 0) + 1;
    } else {
      console.error('Elemento de contagem de curtidas n√£o encontrado.');
    }

  } catch (error) {
    console.error("Erro ao incrementar curtidas: ", error);
  }
}


async function criarElementoPost(postData) {
    const postDiv = document.createElement('div');
    postDiv.classList.add('post');
    postDiv.id = `postCard_${postData.id}`;

    try {
        const user = firebase.auth().currentUser;
        if (!user) {
            throw new Error('Usu√°rio n√£o autenticado');
        }
        const currentUserId = user.uid;

        const autorDoc = await db.collection('users').doc(postData.autorId).get();
        if (!autorDoc.exists) {
            throw new Error('Documento do autor n√£o encontrado');
        }
        const autorData = autorDoc.data();

        const currentUserDoc = await db.collection('users').doc(currentUserId).get();
        if (!currentUserDoc.exists) {
            throw new Error('Documento do usu√°rio logado n√£o encontrado');
        }
        const currentUserData = currentUserDoc.data();

        const isFriend = currentUserData.meusAmigos && currentUserData.meusAmigos.includes(postData.autorId);

        const headerContainer = document.createElement('div');
        headerContainer.classList.add('post-header-container');

        const authorImage = document.createElement('img');
        authorImage.src = autorData.profilePhotoURL || 'placeholder.jpg';
        authorImage.alt = 'Imagem do autor';
        authorImage.classList.add('author-image');
        headerContainer.appendChild(authorImage);

        const authorNameContainer = document.createElement('div');
        authorNameContainer.classList.add('author-name-container');

        const authorName = document.createElement('p');
        authorName.textContent = autorData.name || 'Autor Desconhecido';
        authorName.classList.add('author-name');
        authorNameContainer.appendChild(authorName);

        const optionsList = document.createElement('ul');
        optionsList.id = `optionsList_${postData.id}`;
        optionsList.classList.add('options-list');
        optionsList.style.display = 'none';

        if (!isFriend) {
            const addFriendOption = document.createElement('option-button');
            addFriendOption.textContent = 'Adicionar aos amigos';
            addFriendOption.classList.add('option-button');
            addFriendOption.addEventListener('click', async () => {
                await handleAddFriend(postData.autorId, addFriendOption);
            });
            optionsList.appendChild(addFriendOption);
        }

        const VerUsuario = document.createElement('option-button');
        VerUsuario.textContent = 'Ver Usuario';
        VerUsuario.classList.add('option-button');
        VerUsuario.addEventListener('click', () => VerUsuarioPost(postData));

        const reportOption = document.createElement('option-button');
        reportOption.textContent = 'Denunciar';
        reportOption.classList.add('option-button');
        reportOption.addEventListener('click', () => handleReport(postData));

        optionsList.appendChild(VerUsuario);
        optionsList.appendChild(reportOption);
        authorNameContainer.appendChild(optionsList);
        headerContainer.appendChild(authorNameContainer);

        if (autorData.cidade) {
            const authorcidade = document.createElement('p');
            authorcidade.textContent = `Cidade: ${autorData.cidade}`;
            authorcidade.classList.add('author-cidade');
            headerContainer.appendChild(authorcidade);
        }

        postDiv.appendChild(headerContainer);

        const timestamp = document.createElement('p');
        timestamp.textContent = new Date(postData.timestamp.toDate()).toLocaleString('pt-BR');
        timestamp.classList.add('post-timestamp');
        postDiv.appendChild(timestamp);

		const buttonsContainer = document.createElement('div');
        buttonsContainer.classList.add('buttons-container');
		
         // Cria√ß√£o do cont√™iner de conte√∫do da postagem
    const postContentContainer = document.createElement('div');
    postContentContainer.classList.add('post-content-container');

    // Adiciona texto da postagem
    const postTextParagraph = document.createElement('p');
    postTextParagraph.textContent = postData.texto;
    postTextParagraph.classList.add('post-text');
    postContentContainer.appendChild(postTextParagraph);

    // Adiciona imagem da postagem, se existir
    if (postData.postImageUrl) {
      const postImageContainer = document.createElement('div');
      postImageContainer.classList.add('post-image-container');

      const postImage = document.createElement('img');
      postImage.src = postData.postImageUrl;
      postImage.alt = 'Imagem da postagem';
      postImage.classList.add('post-image');
      postImageContainer.appendChild(postImage);
      postContentContainer.appendChild(postImageContainer);

      // Adiciona cont√™iner de bot√µes de curtida e n√£o curtida dentro do cont√™iner de imagem
      const buttonsContainer = document.createElement('div');
      buttonsContainer.classList.add('buttons-container');

      const likeButtonContainer = document.createElement('div');
      likeButtonContainer.classList.add('like-button-container');

      const likeButton = document.createElement('button');
      likeButton.innerHTML = '&#x1F44D;';
      likeButton.title = 'Gostei';
      likeButton.id = `likeButton_${postData.id}`;
      likeButton.classList.add('like-button');
      likeButton.addEventListener('click', () => handleLike(postData));

      const likesCountElement = document.createElement('span');
      likesCountElement.id = `likesCount_${postData.id}`;
      likesCountElement.textContent = `${postData.Curtidas || 0}`;
      likesCountElement.classList.add('likes-count');

      likeButtonContainer.appendChild(likeButton);
      likeButtonContainer.appendChild(likesCountElement);

      const dislikeButtonContainer = document.createElement('div');
      dislikeButtonContainer.classList.add('dislike-button-container');

      const dislikeButton = document.createElement('button');
      dislikeButton.innerHTML = '&#x1F44E;';
      dislikeButton.title = 'N√£o Gostei';
      dislikeButton.id = `dislikeButton_${postData.id}`;
      dislikeButton.classList.add('dislike-button');
      dislikeButton.addEventListener('click', () => handleDislike(postData));

      const dislikesCountElement = document.createElement('span');
      dislikesCountElement.id = `dislikesCount_${postData.id}`;
      dislikesCountElement.textContent = `${postData.NaoGostei || 0}`;
      dislikesCountElement.classList.add('dislikes-count');

      dislikeButtonContainer.appendChild(dislikeButton);
      dislikeButtonContainer.appendChild(dislikesCountElement);

      buttonsContainer.appendChild(likeButtonContainer);
      buttonsContainer.appendChild(dislikeButtonContainer);

      postImageContainer.appendChild(buttonsContainer);
    }

    // Adiciona conte√∫do da postagem ao postDiv
    postDiv.appendChild(headerContainer);
    postDiv.appendChild(postContentContainer);

        const buttonsDiv = document.createElement('div');
        buttonsDiv.classList.add('buttons-div');

        const commentInput = document.createElement('input');
        commentInput.type = 'text';
        commentInput.placeholder = 'Comente algo!...';
        commentInput.classList.add('comment-input');
        commentInput.id = `commentInput_${postData.id}`;

        const commentButton = document.createElement('button');
        commentButton.textContent = 'Comentar';
        commentButton.classList.add('comment-button');
        commentButton.addEventListener('click', () => handleComment(postData, commentInput));

        const commentsContainer = document.createElement('div');
        commentsContainer.classList.add('comments-container');

        const verMaisButton = document.createElement('button');
        verMaisButton.textContent = 'Ver Mais';
        verMaisButton.classList.add('ver-mais-button');
        verMaisButton.style.display = 'none';

        let lastVisible = null;

        const carregarMaisComentarios = async (postId, container, button) => {
            let query = db.collection('timelineLux').doc(postId).collection('comentarios').orderBy('timestamp', 'asc').limit(3);

            if (lastVisible) {
                query = query.startAfter(lastVisible);
            }

            const comentariosSnapshot = await query.get();

            if (!comentariosSnapshot.empty) {
                comentariosSnapshot.forEach((doc) => {
                    const comentario = doc.data();
                    const commentElement = document.createElement('p');
                    commentElement.textContent = `${comentario.autorNome}: ${comentario.texto}`;
                    container.appendChild(commentElement);
                });

                lastVisible = comentariosSnapshot.docs[comentariosSnapshot.docs.length - 1];

                if (comentariosSnapshot.size < 3) {
                    button.style.display = 'none';
                }
            } else {
                button.style.display = 'none';
            }
        };

        const comentariosRef = db.collection('timelineLux').doc(postData.id).collection('comentarios');
        const comentariosSnapshot = await comentariosRef.orderBy('timestamp', 'asc').limit(3).get();
        if (!comentariosSnapshot.empty) {
            comentariosSnapshot.forEach((doc) => {
                const comentario = doc.data();
                const commentElement = document.createElement('p');
                commentElement.textContent = `${comentario.autorNome}: ${comentario.texto}`;
                commentsContainer.appendChild(commentElement);
            });

            lastVisible = comentariosSnapshot.docs[comentariosSnapshot.docs.length - 1];
            verMaisButton.style.display = 'block';
        }

        verMaisButton.addEventListener('click', () => carregarMaisComentarios(postData.id, commentsContainer, verMaisButton));

        buttonsDiv.appendChild(commentInput);
        buttonsDiv.appendChild(commentButton);
        postContentContainer.appendChild(buttonsDiv);
        postContentContainer.appendChild(commentsContainer);
        postContentContainer.appendChild(verMaisButton);

        postDiv.appendChild(postContentContainer);

        const toggleOptions = (event) => {
            event.stopPropagation();
            optionsList.style.display = optionsList.style.display === 'none' ? 'block' : 'none';
        };

        authorName.addEventListener('click', toggleOptions);
        authorImage.addEventListener('click', toggleOptions);

        document.addEventListener('click', (event) => {
            if (!optionsList.contains(event.target) && event.target !== authorName && event.target !== authorImage) {
                optionsList.style.display = 'none';
            }
        });

        return postDiv;
    } catch (error) {
        console.error('Erro ao criar elemento de postagem:', error);
        return null;
    }
}

async function VerUsuarioPost(postData) {
  try {
    // Buscar autor pelo ID na cole√ß√£o "users"
    const autorDoc = await db.collection('users').doc(postData.autorId).get();
    if (!autorDoc.exists) {
      throw new Error('Documento do autor n√£o encontrado');
    }
    const autorData = autorDoc.data();

    // Pega o elemento do modal e o conte√∫do do modal
    const modal = document.getElementById('userModal');
    const modalContent = document.getElementById('modalUserContent');

    // Limpa o conte√∫do do modal
    modalContent.innerHTML = '';

    // Adiciona as informa√ß√µes do usu√°rio ao modal
    const userInfo = document.createElement('div');
    userInfo.innerHTML = `
      <p><strong>Nome:</strong> ${autorData.name || 'Desconhecido'}</p>
      <p><strong>Email:</strong> ${autorData.email || 'N√£o dispon√≠vel'}</p>
      <p><strong>G√™nero:</strong> ${autorData.description || 'N√£o especificado'}</p>
      <p><strong>Renda:</strong> ${autorData.income || 'N√£o dispon√≠vel'}</p>
      <p><strong>Procurando por:</strong> ${autorData.lookingFor || 'N√£o especificado'}</p>
      <p><strong>Cidade:</strong> ${autorData.cidade || 'N√£o dispon√≠vel'}</p>
      <img src="${autorData.profilePhotoURL || 'placeholder.jpg'}" alt="Foto do usu√°rio" class="modal-user-image">
    `;
    modalContent.appendChild(userInfo);

    // Adiciona o bot√£o "Adicionar aos amigos" ao modal
    const addFriendButton = document.createElement('button');
    addFriendButton.textContent = 'Adicionar aos amigos';
    addFriendButton.classList.add('add-friend-button');
    addFriendButton.addEventListener('click', () => handleAddFriend(postData.autorId));
    modalContent.appendChild(addFriendButton);

    // Exibe o modal
    modal.style.display = 'block';

    // Fecha o modal quando o usu√°rio clica no "x"
    const span = document.getElementsByClassName('close')[0];
    span.onclick = function() {
      modal.style.display = 'none';
    }

    // Fecha o modal quando o usu√°rio clica fora do conte√∫do do modal
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Oculta as op√ß√µes do post
    const optionsList = document.getElementById(`optionsList_${postData.id}`);
    if (optionsList) {
      optionsList.style.display = 'none';
    }

  } catch (error) {
    console.error('Erro ao buscar dados do usu√°rio:', error);
    alert('Erro ao carregar informa√ß√µes do usu√°rio.');
  }
}




async function handleAddFriend(autorId, button) {
  const currentUser = firebase.auth().currentUser;
  if (!currentUser) {
    alert('Voc√™ precisa estar logado para adicionar amigos.');
    return;
  }

  try {
    const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
    if (!currentUserDoc.exists) {
      throw new Error('Documento do usu√°rio atual n√£o encontrado');
    }

    // Atualizar o documento do autor da postagem
    await db.collection('users').doc(autorId).update({
      solicitacoesRecebidas: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });

    // Atualizar o documento do usu√°rio atual
    await db.collection('users').doc(currentUser.uid).update({
      solicitacoesEnviadas: firebase.firestore.FieldValue.arrayUnion(autorId)
    });

    // Atualizar o texto e a funcionalidade do bot√£o
    button.textContent = 'Cancelar solicita√ß√£o';
    button.removeEventListener('click', () => handleAddFriend(autorId, button));
    button.addEventListener('click', () => handleCancelFriendRequest(autorId, button));

    alert('Solicita√ß√£o de amizade enviada com sucesso!');
  } catch (error) {
    console.error('Erro ao enviar solicita√ß√£o de amizade:', error);
    alert('Erro ao enviar solicita√ß√£o de amizade.');
  }
}

async function handleCancelFriendRequest(autorId, button) {
  const currentUser = firebase.auth().currentUser;
  if (!currentUser) {
    alert('Voc√™ precisa estar logado para cancelar a solicita√ß√£o de amizade.');
    return;
  }

  try {
    // Atualizar o documento do autor da postagem
    await db.collection('users').doc(autorId).update({
      solicitacoesRecebidas: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
    });

    // Atualizar o documento do usu√°rio atual
    await db.collection('users').doc(currentUser.uid).update({
      solicitacoesEnviadas: firebase.firestore.FieldValue.arrayRemove(autorId)
    });

    // Atualizar o texto e a funcionalidade do bot√£o
    button.textContent = 'Adicionar aos amigos';
    button.removeEventListener('click', () => handleCancelFriendRequest(autorId, button));
    button.addEventListener('click', () => handleAddFriend(autorId, button));

    alert('Solicita√ß√£o de amizade cancelada com sucesso!');
  } catch (error) {
    console.error('Erro ao cancelar solicita√ß√£o de amizade:', error);
    alert('Erro ao cancelar solicita√ß√£o de amizade.');
  }
}


function toggleOptions(event, postId) {
  const optionsList = document.getElementById(`optionsList_${postId}`);
  if (optionsList.style.display === 'block') {
    optionsList.style.display = 'none';
  } else {
    optionsList.style.display = 'block';
  }
}

function toggleSection(sectionId) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => {
        section.style.display = 'none';
    });

    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.style.display = 'block';

        if (sectionId === 'section2') {
            exibirPostagens();
        }

        if (sectionId === 'section3') {
            if (currentUserId) {
                loadReceivedRequests(currentUserId);
                loadFriendsList(currentUserId);
            } else {
                console.error('Erro: currentUserId n√£o est√° definido');
            }
        }

        if (sectionId === 'section5') {
            const albumGallery = document.getElementById('albumGallery');
            if (albumGallery) {
                loadAlbums(); // Carrega os √°lbuns ao abrir a section5
            } else {
                console.error('Elemento albumGallery n√£o encontrado!');
            }
        }

        if (sectionId === 'section8') { 
            fetchRandomUsers();
        }
    }
}




// Fun√ß√£o para buscar e exibir as solicita√ß√µes recebidas
async function loadReceivedRequests(currentUserId) {
  try {
    const userDoc = await db.collection('users').doc(currentUserId).get();
    const userData = userDoc.data();
    const receivedRequests = userData.solicitacoesRecebidas || [];

    const container = document.getElementById('receivedRequestsContainer');
    container.innerHTML = '';

    receivedRequests.forEach(async (requestId) => {
      const requestDoc = await db.collection('users').doc(requestId).get();
      const requestData = requestDoc.data();

      const requestCard = document.createElement('div');
      requestCard.classList.add('request-card');

      const requestInfo = document.createElement('div');
      requestInfo.classList.add('request-info');
      requestInfo.innerHTML = `
        <p><strong>Nome:</strong> ${requestData.name}</p>
        <p><strong>Email:</strong> ${requestData.email}</p>
      `;
      requestCard.appendChild(requestInfo);

      const requestActions = document.createElement('div');
      requestActions.classList.add('request-actions');

      const acceptButton = document.createElement('button');
      acceptButton.textContent = 'Aceitar';
      acceptButton.classList.add('accept-button');
      acceptButton.addEventListener('click', () => acceptRequest(currentUserId, requestId));

      const rejectButton = document.createElement('button');
      rejectButton.textContent = 'Rejeitar';
      rejectButton.classList.add('reject-button');
      rejectButton.addEventListener('click', () => rejectRequest(currentUserId, requestId));

      requestActions.appendChild(acceptButton);
      requestActions.appendChild(rejectButton);
      requestCard.appendChild(requestActions);

      container.appendChild(requestCard);
    });
  } catch (error) {
    console.error('Erro ao buscar solicita√ß√µes recebidas:', error);
  }
}

// Fun√ß√£o para carregar a lista de amigos
async function loadFriendsList(currentUserId) {
  try {
    const userDoc = await db.collection('users').doc(currentUserId).get();
    const userData = userDoc.data();
    const friendsList = userData.meusAmigos || [];

    const container = document.getElementById('friendsListContainer');
    container.innerHTML = '';

    // Itera pelos amigos
    for (const friendId of friendsList) {
      const friendDoc = await db.collection('users').doc(friendId).get();
      const friendData = friendDoc.data();

      // Cria um elemento para exibir o amigo
      const friendCard = document.createElement('div');
      friendCard.classList.add('friend-card');

      // Informa√ß√µes do amigo (imagem e nome)
      const friendInfo = document.createElement('div');
      friendInfo.classList.add('friend-info');

      // Imagem do perfil do amigo
      const friendImage = document.createElement('img');
      friendImage.src = friendData.profilePhotoURL || 'placeholder.jpg';
      friendImage.alt = 'Foto de perfil do amigo';
      friendImage.classList.add('friend-image');
      friendInfo.appendChild(friendImage);

      // Nome do amigo
      const friendName = document.createElement('p');
      friendName.textContent = friendData.name || 'Nome n√£o dispon√≠vel';
      friendInfo.appendChild(friendName);

      // Adiciona as informa√ß√µes do amigo ao card
      friendCard.appendChild(friendInfo);

      // Bot√£o "Chat"
      const chatButton = document.createElement('button');
      chatButton.textContent = 'Chat';
      chatButton.classList.add('friend-button');
      chatButton.addEventListener('click', () => openChatbox(friendId, friendData.name)); // Chama openChatbox
      friendCard.appendChild(chatButton);

      // Bot√£o "Remover Amizade"
      const removeFriendButton = document.createElement('button');
      removeFriendButton.textContent = 'Remover Amizade';
      removeFriendButton.classList.add('friend-button');
      removeFriendButton.addEventListener('click', () => removerAmizade(currentUserId, friendId)); // Fun√ß√£o a ser implementada para remover a amizade
      friendCard.appendChild(removeFriendButton);

      // Bot√£o "Ver Perfil"
      const viewProfileButton = document.createElement('button');
      viewProfileButton.textContent = 'Ver Perfil';
      viewProfileButton.classList.add('view-profile-btn');
      viewProfileButton.addEventListener('click', () => viewProfile(friendId)); // Chama viewProfile com o ID do amigo
      friendCard.appendChild(viewProfileButton);

      // Adiciona o card do amigo ao container
      container.appendChild(friendCard);
    }
  } catch (error) {
    console.error('Erro ao buscar lista de amigos:', error);
  }
}


// Fun√ß√£o para carregar mais coment√°rios
async function carregarMaisComentarios(postId, commentsContainer, verMaisButton) {
  const comentariosRef = db.collection('timelineLux').doc(postId).collection('comentarios');

  // Desabilita o bot√£o enquanto carrega os coment√°rios adicionais para evitar m√∫ltiplos cliques
  verMaisButton.disabled = true;
  verMaisButton.textContent = 'Carregando...';

  let lastCommentTimestamp = null;
  const lastVisible = commentsContainer.lastChild;
  
  if (lastVisible) {
    const lastCommentText = lastVisible.textContent.split(': ')[1];
    const lastCommentSnapshot = await comentariosRef.where('texto', '==', lastCommentText).get();
    
    if (!lastCommentSnapshot.empty) {
      lastCommentSnapshot.forEach(doc => {
        lastCommentTimestamp = doc.data().timestamp;
      });
    }
  }

  // Consulta os pr√≥ximos 3 coment√°rios ap√≥s o √∫ltimo coment√°rio carregado
  const comentariosSnapshot = await comentariosRef.orderBy('timestamp', 'asc')
    .startAfter(lastCommentTimestamp)
    .limit(3)
    .get();

  if (comentariosSnapshot.empty) {
    verMaisButton.style.display = 'none'; // Oculta o bot√£o "Ver Mais" se n√£o houver mais coment√°rios
  } else {
    comentariosSnapshot.forEach((doc) => {
      const comentario = doc.data();
      const commentElement = document.createElement('p');
      commentElement.textContent = `${comentario.autorNome}: ${comentario.texto}`;
      commentsContainer.appendChild(commentElement);
    });
  }

  // Reabilita o bot√£o "Ver Mais" se houver mais coment√°rios para carregar
  verMaisButton.disabled = false;
  verMaisButton.textContent = 'Ver Mais';
}


// Fun√ß√£o para lidar com a adi√ß√£o de coment√°rio
async function handleComment(postData, commentInput) {
  const commentText = commentInput.value.trim();

  if (!commentText) {
    alert('Por favor, digite seu coment√°rio antes de enviar.');
    return;
  }

  // Refer√™ncia ao usu√°rio autenticado
  const user = firebase.auth().currentUser;

  // Verifica se o usu√°rio est√° autenticado
  if (!user) {
    alert('Usu√°rio n√£o autenticado. Fa√ßa login para comentar.');
    return;
  }

  const userId = user.uid; // ID √∫nico do usu√°rio

  // Buscar o nome do usu√°rio a partir do ID
  let userName;
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
      userName = userDoc.data().name || "Usu√°rio An√¥nimo"; // Use o campo 'name' do documento do usu√°rio
    } else {
      console.error('Documento de usu√°rio n√£o encontrado');
      userName = "Usu√°rio An√¥nimo";
    }
  } catch (error) {
    console.error('Erro ao buscar nome do usu√°rio:', error);
    userName = "Usu√°rio An√¥nimo";
  }

  // Verifica novamente se o userName est√° definido
  if (!userName) {
    userName = "Usu√°rio An√¥nimo";
  }

  // Objeto de coment√°rio
  const newComment = {
    texto: commentText,
    autorId: userId,
    autorNome: userName,
    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Adiciona timestamp aqui
  };

  // Refer√™ncia para a cole√ß√£o timelineLux
  const timelineLuxRef = db.collection('timelineLux').doc(postData.id);

  // Refer√™ncia para a subcole√ß√£o comentarios dentro do documento da postagem
  const comentariosRef = timelineLuxRef.collection('comentarios');

  // Adiciona o coment√°rio na subcole√ß√£o comentarios
  try {
    const docRef = await comentariosRef.add(newComment);
    console.log('Coment√°rio adicionado na subcole√ß√£o comentarios do documento:', docRef.id);
    commentInput.value = ''; // Limpa o campo de input ap√≥s enviar o coment√°rio

    // Atualiza a exibi√ß√£o dos coment√°rios imediatamente
    const postCard = document.querySelector(`#postCard_${postData.id}`);
    if (postCard) {
      const commentsContainer = postCard.querySelector('.comments-container');
      if (commentsContainer) {
        const commentElement = document.createElement('p');
        commentElement.textContent = `${userName}: ${commentText}`;
        commentsContainer.appendChild(commentElement);
      } else {
        console.error('Elemento para exibi√ß√£o de coment√°rios n√£o encontrado');
      }
    } else {
      console.error('Elemento de postagem n√£o encontrado');
    }
  } catch (error) {
    console.error('Erro ao adicionar coment√°rio:', error);
  }
}





</script>


</body>

</html>
